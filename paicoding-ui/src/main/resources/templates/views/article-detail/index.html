<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
  <title th:text="${vo.article.title} + '-æŠ€æœ¯æ´¾'">æŠ€æœ¯æ´¾</title>
</div>

<link rel="stylesheet" href="/css/views/article-detail.css"
      th:href="${global.siteInfo.oss + '/css/views/article-detail.css'}" />
<script src="/js/biz/selection.js" th:src="${global.siteInfo.oss + '/js/biz/selection.js'}"></script>

<body id="body" class="bg-color">
<!-- å¯¼èˆªæ  -->
<div th:replace="components/layout/navbar :: navbar"></div>

<div class="home article-detail">
  <div class="col-body pg-2-article">
    <div class="com-3-layout">
      <div class="layout-main">
        <!-- å·¦è¾¹ç‚¹èµã€æ”¶è—ã€è¯„è®ºæµ®çª— -->
        <div th:replace="views/article-detail/side-float-action-bar/index :: tool_bar(${vo.article})"></div>

        <!-- æ­£æ–‡ -->
        <div
                th:replace="components/article/article-detail :: article_info(${vo.article}, ${vo.author}, ${vo.other}, ${vo.payUsers})">
        </div>

        <!--  è¯„è®º  -->
        <div id="commentDiv">
          <div th:replace="views/article-detail/comment/index"></div>
        </div>

        <div class="correlation-article bg-color-white" id="relatedRecommend">
          <!-- å…³è”æ¨è -->
          <h4 class="correlation-article-title">ç›¸å…³æ¨è</h4>
          <div class="bg-color-white">
            <div id="articleList"></div>
          </div>
        </div>
      </div>

      <div class="layout-side">
        <!-- ç”¨æˆ·ç›¸å…³ä¿¡æ¯ -->
        <div
                th:replace="components/user/user-card :: user_card(${vo.author}, ${vo.article.author}, ${global.isLogin})">
        </div>

        <!-- æ´»åŠ¨æ¨è -->
        <div th:if="${!#lists.isEmpty(vo.sideBarItems)}">
          <div th:replace="views/article-detail/side-recommend-bar/index">
            ä¾§è¾¹é€šçŸ¥æ¿å—
          </div>
        </div>
        <div id="toc-container-position"></div>
        <!-- æ–‡ç« èœå•  -->
        <div class="right-container toc-container">
          <div class="widget">
            <h3 class="com-nav-bar-title">ç›®å½•</h3>
            <div id="contentMenu" class="toc"></div>
          </div>
        </div>

        <!-- å¼•ç”¨è¯„è®ºä¾§è¾¹æ  -->
        <div id="quoteCommentSidebar" class="right-container quote-comment-sidebar" style="display: none;">
          <div class="widget">
            <h3 class="com-nav-bar-title">å¼•ç”¨è¯„è®º</h3>
            <div class="quote-content">
              <div class="quote-text" id="quotedText"></div>
              <div class="quote-comment-form">
                <textarea id="quoteCommentInput" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." class="form-control"></textarea>
                <button id="submitQuoteComment" class="c-btn c-btn-primary mt-2" disabled>æäº¤è¯„è®º</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- åº•éƒ¨ä¿¡æ¯ -->
  <div th:replace="components/layout/footer :: footer"></div>
</div>

<!-- å·¦è¾¹ç‚¹èµã€æ”¶è—ã€è¯„è®ºæµ®çª— -->
<div th:replace="views/article-detail/side-float-action-bar-md/index :: tool_bar(${vo.article})"></div>

<div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åˆ†äº«æ–‡ç« </h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body text-center">
        <div class="qrcode-container mb-3">
          <img id="shareQrCode" src="" alt="åˆ†äº«äºŒç»´ç " style="width:200px;height:200px;">
        </div>
        <div class="short-url-container">
          <div class="input-group">
            <input type="text" id="shortUrl" class="form-control" readonly style="font-size: 1rem;">
            <div class="input-group-append">
              <button class="btn btn-outline-secondary" type="button" onclick="copyAndClose()">å¤åˆ¶</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script th:inline="javascript">
  /*<![CDATA[*/
  // å†…å®¹æ¸²æŸ“
  const articleId = [[${ vo.article.articleId }]];

  // ç”Ÿæˆèœå•
  genTocMenu('#articleContent', '#contentMenu');

  // è·³è½¬åˆ°è¯„è®ºçš„åœ°æ–¹
  $("#commentFloatBtn,#commentFloatBtnMd").click(function () {
    document.getElementById("commentList").scrollIntoView(true);
  })

  if (window.location.href.indexOf("#commentList") >= 0) {
    document.getElementById("commentList").scrollIntoView(true);
  }

  // ç‚¹èµ
  let praisedCount = [[${ vo.article.count.praiseCount }]]
  let praised = [[${ vo.article.praised }]]
  const isLogin = [[${ global.isLogin }]]
  const currentUserId = isLogin ? [[${ global.user != null ? global.user.userId : '' }]] : '';
  const currentUserAvatar = isLogin ? [[${ global.user != null ? global.user.photo : '' }]] : '';

  // æ–‡æœ¬é€‰æ‹©åŠŸèƒ½
  let selectedText = '';
  let selectionRange = null;
  let toSaveSelection = null;
  // ä¿å­˜è¢«éšè—çš„ä¾§è¾¹æ å…ƒç´ 
  let hiddenSidebars = [];
  // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç†è¯„è®ºå›¾æ ‡ç‚¹å‡»
  let isHandlingCommentIcon = false;

  // ç›‘å¬æ–‡æœ¬é€‰æ‹©äº‹ä»¶
  document.addEventListener('selectionchange', function () {
    // å¦‚æœæ­£åœ¨å¤„ç†è¯„è®ºå›¾æ ‡ç‚¹å‡»ï¼Œå¿½ç•¥é€‰æ‹©å˜åŒ–
    if (isHandlingCommentIcon) {
      // console.debug('æ­£åœ¨å¤„ç†è¯„è®ºå›¾æ ‡ç‚¹å‡»ï¼Œå¿½ç•¥é€‰æ‹©å˜åŒ–');
      return;
    }

    const selection = window.getSelection();
    if (selection.toString().trim() !== '' && isElementInArticleContent(selection.anchorNode)) {
      selectedText = selection.toString().trim();
      selectionRange = selection.getRangeAt(0);
      // console.debug('æ£€æµ‹åˆ°æ–‡æœ¬é€‰æ‹©:', selectedText); // è°ƒè¯•ä¿¡æ¯
      // ä¸å†ç›´æ¥æ˜¾ç¤ºä¾§è¾¹æ ï¼Œè€Œæ˜¯åœ¨æ–‡æœ¬é™„è¿‘æ˜¾ç¤ºè¯„è®ºå›¾æ ‡
      showCommentIcon(selectionRange);
    } else if (selection.toString().trim() === '') {
      // console.debug('æ–‡æœ¬é€‰æ‹©å·²æ¸…é™¤'); // è°ƒè¯•ä¿¡æ¯
      // éšè—è¯„è®ºå›¾æ ‡
      hideCommentIcon();
    }
  });

  // æ·»åŠ é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢åœ¨å›¾æ ‡ä¸ŠæŒ‰ä¸‹é¼ æ ‡æ—¶æ¸…é™¤é€‰æ‹©
  document.addEventListener('mousedown', function (e) {
    const commentIcon = document.getElementById('comment-icon');
    if (commentIcon && commentIcon.contains(e.target)) {
      // console.debug('åœ¨è¯„è®ºå›¾æ ‡ä¸ŠæŒ‰ä¸‹é¼ æ ‡');
      e.preventDefault();
      isHandlingCommentIcon = true;

      // çŸ­æš‚è®¾ç½®æ ‡è®°ï¼Œç¡®ä¿ç‚¹å‡»äº‹ä»¶èƒ½æ­£å¸¸å¤„ç†
      setTimeout(() => {
        isHandlingCommentIcon = false;
      }, 300);
    }
  }, true);


  // æ£€æŸ¥é€‰ä¸­çš„å…ƒç´ æ˜¯å¦åœ¨æ–‡ç« å†…å®¹åŒºåŸŸå†…
  function isElementInArticleContent(element) {
    if (!element) return false;
    const articleContent = document.getElementById('articleContent');
    const result = articleContent && articleContent.contains(element);
    // console.debug('å…ƒç´ æ˜¯å¦åœ¨æ–‡ç« å†…å®¹åŒºåŸŸå†…:', result); // è°ƒè¯•ä¿¡æ¯
    return result;
  }

  // æ˜¾ç¤ºè¯„è®ºå›¾æ ‡
  function showCommentIcon(range) {
    // ç§»é™¤å·²å­˜åœ¨çš„è¯„è®ºå›¾æ ‡
    hideCommentIcon();

    // åˆ›å»ºè¯„è®ºå›¾æ ‡
    const commentIcon = document.createElement('div');
    commentIcon.id = 'comment-icon';
    commentIcon.innerHTML = 'ğŸ’¬';


    // è·å–é€‰ä¸­æ–‡æœ¬çš„ä½ç½®
    const rect = range.getBoundingClientRect();
    commentIcon.style.top = (window.scrollY + rect.top - 30) + 'px';
    commentIcon.style.left = (window.scrollX + rect.right) + 'px';

    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(commentIcon);

    // ç¡®ä¿å›¾æ ‡å·²æ·»åŠ åˆ°DOMåå†ç»‘å®šäº‹ä»¶
    setTimeout(() => {
      const icon = document.getElementById('comment-icon');
      if (icon) {
        icon.addEventListener('click', handleCommentIconClick);
        icon.addEventListener('mousedown', function (e) {
          e.preventDefault(); // é˜²æ­¢é¼ æ ‡æŒ‰ä¸‹æ—¶æ¸…é™¤é€‰æ‹©
        });
      }
    }, 0);
  }

  // è¯„è®ºå›¾æ ‡ç‚¹å‡»å¤„ç†å‡½æ•°
  function handleCommentIconClick(e) {
    e.stopPropagation();
    e.preventDefault();

    // ä¿å­˜å½“å‰é€‰æ‹©çš„æ–‡æœ¬èŒƒå›´
    const savedRange = selectionRange;
    toSaveSelection = rangeToElementJSON(savedRange);
    console.log('éœ€è¦ä¿å­˜çš„åˆ’çº¿å†…å®¹:', savedRange, toSaveSelection);

    // è®¾ç½®æ ‡è®°ï¼Œé˜²æ­¢é€‰æ‹©å˜åŒ–äº‹ä»¶éšè—å›¾æ ‡
    isHandlingCommentIcon = true;

    showQuoteCommentSidebar(selectedText);
    hideCommentIcon();

    // é‡æ–°åº”ç”¨é€‰æ‹©ï¼Œä¿æŒæ–‡æœ¬é€‰ä¸­çŠ¶æ€ï¼Œå¹¶æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
    setTimeout(() => {
      if (savedRange) {
        // ä¸ºé€‰ä¸­çš„æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
        applyUnderlineToSelection(savedRange);
      }

      // é‡ç½®æ ‡è®°
      isHandlingCommentIcon = false;
    }, 50);

    // èšç„¦åˆ°è¯„è®ºè¾“å…¥æ¡†
    setTimeout(function () {
      const commentInput = document.getElementById('quoteCommentInput');
      if (commentInput) {
        commentInput.focus();
      }
    }, 100);
  }

  // ä¸ºé€‰ä¸­çš„æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
  const highlightComments = [[${ vo.highlightComments }]]
  console.log('highlightComments:', highlightComments)
  if (highlightComments) {
    initUnderlineToSelection(highlightComments);
  }
  function initUnderlineToSelection(commentList) {
    for (let i = 0; i < commentList.length; i++) {
      const comment = commentList[i];
      const commentText = comment.highlight;
      if (commentText) {
        let range = elementJSONToRange(commentText)
        if (range) {
          try {
            // åˆ›å»ºä¸€ä¸ªæ–°çš„èŒƒå›´æ¥åŒ…è£…é€‰ä¸­çš„æ–‡æœ¬
            const newNode = document.createElement('span');
            newNode.style.textDecoration = 'underline';
            newNode.style.textDecorationColor = '#ff6900';
            newNode.style.textDecorationStyle = 'wavy';
            newNode.className = 'selected-text-highlight';

            // ä½¿ç”¨ surroundContents æ–¹æ³•åŒ…è£…é€‰ä¸­çš„å†…å®¹
            range.surroundContents(newNode);
          } catch (e) {
            console.debug('æ— æ³•ä¸ºé€‰ä¸­æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼:', e);
          }
        }
      }
    }
  }

  // ä¸ºé€‰ä¸­çš„æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
  function applyUnderlineToSelection(range) {
    try {
      // åˆ›å»ºä¸€ä¸ªæ–°çš„èŒƒå›´æ¥åŒ…è£…é€‰ä¸­çš„æ–‡æœ¬
      const newNode = document.createElement('span');
      newNode.style.textDecoration = 'underline';
      newNode.style.textDecorationColor = '#ff6900';
      newNode.style.textDecorationStyle = 'wavy';
      newNode.className = 'selected-text-highlight';

      // ä½¿ç”¨ surroundContents æ–¹æ³•åŒ…è£…é€‰ä¸­çš„å†…å®¹
      range.surroundContents(newNode);

      // ä¿å­˜é«˜äº®å…ƒç´ çš„å¼•ç”¨ï¼Œä»¥ä¾¿åç»­å¯ä»¥ç§»é™¤
      if (!window.highlightedElements) {
        window.highlightedElements = [];
      }
      window.highlightedElements.push(newNode);
    } catch (e) {
      console.debug('æ— æ³•ä¸ºé€‰ä¸­æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼:', e);
      // å¦‚æœ surroundContents å¤±è´¥ï¼Œä½¿ç”¨å¦ä¸€ç§æ–¹æ³•
      // æ³¨æ„ï¼šä¸è¦é‡æ–°å£°æ˜rangeå˜é‡ï¼Œä½¿ç”¨ä¼ å…¥çš„rangeå‚æ•°
      if (range) {
        try {
          const selectedContent = range.extractContents();
          const span = document.createElement('span');
          span.style.textDecoration = 'underline';
          span.style.textDecorationColor = '#ff6900';
          span.style.textDecorationStyle = 'wavy';
          span.className = 'selected-text-highlight';
          span.appendChild(selectedContent);
          range.insertNode(span);

          // ä¿å­˜é«˜äº®å…ƒç´ çš„å¼•ç”¨
          if (!window.highlightedElements) {
            window.highlightedElements = [];
          }
          window.highlightedElements.push(span);
        } catch (e2) {
          console.debug('ç¬¬äºŒç§æ–¹æ³•ä¹Ÿå¤±è´¥äº†:', e2);
        }
      }
    }
  }

  // ç§»é™¤æ‰€æœ‰é«˜äº®æ ·å¼
  function removeHighlights() {
    if (window.highlightedElements) {
      window.highlightedElements.forEach(element => {
        if (element.parentNode) {
          // å°†å­èŠ‚ç‚¹ç§»å‡º span å…ƒç´ å¹¶åˆ é™¤ span
          while (element.firstChild) {
            element.parentNode.insertBefore(element.firstChild, element);
          }
          element.parentNode.removeChild(element);
        }
      });
      window.highlightedElements = [];
    }
  }

  // åœ¨éšè—å¼•ç”¨è¯„è®ºä¾§è¾¹æ æ—¶ç§»é™¤é«˜äº®
  const originalHideQuoteCommentSidebar = hideQuoteCommentSidebar;
  hideQuoteCommentSidebar = function () {
    // ç§»é™¤é«˜äº®æ ·å¼
    removeHighlights();
    // è°ƒç”¨åŸå§‹å‡½æ•°
    originalHideQuoteCommentSidebar();
  };

  // éšè—è¯„è®ºå›¾æ ‡
  function hideCommentIcon() {
    const commentIcon = document.getElementById('comment-icon');
    if (commentIcon) {
      commentIcon.removeEventListener('click', handleCommentIconClick);
      commentIcon.remove();
    }
  }

  // æ˜¾ç¤ºå¼•ç”¨è¯„è®ºä¾§è¾¹æ 
  function showQuoteCommentSidebar(text) {
    if (!isLogin) {
      console.log('ç”¨æˆ·æœªç™»å½•ï¼Œä¸æ˜¾ç¤ºå¼•ç”¨è¯„è®ºä¾§è¾¹æ ');
      return; // æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤º
    }

    const sidebar = document.getElementById('quoteCommentSidebar');
    const quoteText = document.getElementById('quotedText');

    // console.debug('å°è¯•æ˜¾ç¤ºå¼•ç”¨è¯„è®ºä¾§è¾¹æ :');
    // console.debug('- é€‰ä¸­æ–‡æœ¬:', text);
    // console.debug('- ä¾§è¾¹æ å…ƒç´ å­˜åœ¨:', !!sidebar);
    // console.debug('- å¼•ç”¨æ–‡æœ¬å…ƒç´ å­˜åœ¨:', !!quoteText);
    // console.debug('- ç”¨æˆ·ç™»å½•çŠ¶æ€:', isLogin);

    if (sidebar && quoteText) {
      // éšè—å…¶ä»–ä¾§è¾¹æ 
      hideOtherSidebars();

      // è®¾ç½®å¼•ç”¨æ–‡æœ¬
      quoteText.textContent = text;

      // æ˜¾ç¤ºä¾§è¾¹æ  - ä½¿ç”¨æ›´å¯é çš„æ–¹å¼
      sidebar.style.display = 'block';
      sidebar.style.visibility = 'visible';

      // ç¡®ä¿ä¾§è¾¹æ åœ¨è§†å›¾ä¸­
      sidebar.style.position = 'sticky';
      sidebar.style.top = '20px';

      // æ¸…ç©ºè¾“å…¥æ¡†
      const commentInput = document.getElementById('quoteCommentInput');
      if (commentInput) {
        commentInput.value = '';
      }

      const submitBtn = document.getElementById('submitQuoteComment');
      if (submitBtn) {
        submitBtn.disabled = true;
      }

    } else {
      // å†æ¬¡å°è¯•æŸ¥æ‰¾å…ƒç´ 
      setTimeout(() => {
        const retrySidebar = document.getElementById('quoteCommentSidebar');
        const retryQuoteText = document.getElementById('quotedText');
        console.log('é‡è¯•æŸ¥æ‰¾å…ƒç´ :', retrySidebar, retryQuoteText);
      }, 100);
    }
  }

  // éšè—å¼•ç”¨è¯„è®ºä¾§è¾¹æ 
  function hideQuoteCommentSidebar() {
    const sidebar = document.getElementById('quoteCommentSidebar');
    if (sidebar) {
      sidebar.style.display = 'none';
      sidebar.style.visibility = 'hidden';
      // æ¢å¤å…¶ä»–ä¾§è¾¹æ 
      showOtherSidebars();
    }
  }

  // éšè—å…¶ä»–ä¾§è¾¹æ 
  function hideOtherSidebars() {
    // è·å–æ‰€æœ‰éœ€è¦éšè—çš„ä¾§è¾¹æ å…ƒç´ 
    const sidebars = document.querySelectorAll('.layout-side > .right-container, .layout-side > div:not(#quoteCommentSidebar)');
    hiddenSidebars = [];

    sidebars.forEach(function (sidebar) {
      // æ’é™¤å¼•ç”¨è¯„è®ºä¾§è¾¹æ æœ¬èº«
      if (sidebar.id !== 'quoteCommentSidebar' && sidebar.style.display !== 'none') {
        hiddenSidebars.push({
          element: sidebar,
          display: sidebar.style.display || getComputedStyle(sidebar).display
        });
        sidebar.style.display = 'none';
      }
    });
  }

  // æ¢å¤å…¶ä»–ä¾§è¾¹æ 
  function showOtherSidebars() {
    hiddenSidebars.forEach(function (item) {
      item.element.style.display = item.display;
    });
    hiddenSidebars = [];
  }

  // æ·»åŠ ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—å¼•ç”¨è¯„è®ºä¾§è¾¹æ çš„åŠŸèƒ½
  document.addEventListener('click', function (e) {
    const sidebar = document.getElementById('quoteCommentSidebar');
    const commentInput = document.getElementById('quoteCommentInput');

    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ä¾§è¾¹æ å†…éƒ¨å…ƒç´ ï¼Œä¹Ÿä¸æ˜¯è¯„è®ºè¾“å…¥æ¡†ï¼Œåˆ™éšè—ä¾§è¾¹æ 
    if (sidebar && sidebar.style.display !== 'none' &&
            !sidebar.contains(e.target) &&
            e.target !== commentInput) {
      hideQuoteCommentSidebar();
    }
  });

  // ç›‘å¬å¼•ç”¨è¯„è®ºè¾“å…¥æ¡†
  document.getElementById('quoteCommentInput').addEventListener('input', function () {
    const submitBtn = document.getElementById('submitQuoteComment');
    submitBtn.disabled = this.value.trim() === '';
  });

  // æäº¤å¼•ç”¨è¯„è®º
  document.getElementById('submitQuoteComment').addEventListener('click', function () {
    const commentInput = document.getElementById('quoteCommentInput');
    const commentContent = commentInput.value.trim();

    if (commentContent === '') {
      toastr.error("è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º");
      return;
    }

    // æäº¤è¯„è®º
    const params = {
      articleId: articleId,
      commentContent: commentContent,
      highlight: toSaveSelection,
    };

    console.log('å‡†å¤‡æäº¤è¯„è®ºä¿¡æ¯:', params)
    post("/comment/api/post", params, function (data) {
      // è¯„è®ºæˆåŠŸåéšè—ä¾§è¾¹æ å¹¶æ¸…ç©ºè¾“å…¥æ¡†
      hideQuoteCommentSidebar();
      commentInput.value = '';

      // æ›´æ–°è¯„è®ºåˆ—è¡¨
      document.getElementById("commentDiv").innerHTML = data;
      bindCommentInputEvent();

      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      toastr.success("è¯„è®ºå‘è¡¨æˆåŠŸ");
    });
  });

  function praiseFunc() {
    if (!isLogin) {
      // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
      return;
    }

    praised = !praised;

    praiseArticle(articleId, praised, function (data) {
      let avatarList = $('#praiseUsers')
      if (praised) {
        // ç‚¹èµ
        praisedCount += 1;
        $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").addClass("active")

        // æ·»åŠ å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
        avatarList.prepend('' +
                '            <a class="g-user-popover approval-img" href="/user/' + currentUserId + '">\n' +
                '                <img src="' + currentUserAvatar + '">\n' +
                '            </a>')
      } else {
        // å–æ¶ˆç‚¹èµ
        praisedCount -= 1;
        $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").removeClass("active")

        // ç§»é™¤å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
        let subItems = avatarList.children();
        for (let i = 0; i < subItems.length; i++) {
          let target = subItems[i];
          if (target.innerHTML.indexOf(currentUserAvatar) >= 0) {
            // ç§»é™¤å½“å‰ç”¨æˆ·å¤´åƒ
            target.remove();
            break;
          }
        }
      }

      if (praisedCount > 0) {
        $("#praiseFloatBtn, #praiseFloatBtnMd").addClass("with-badge")
        $('#praiseFloatBtn, #praiseFloatBtnMd').attr("badge", praisedCount)
        $('#praiseDesc').text(String(praisedCount) + 'äººå·²ç‚¹èµ');

      } else {
        $("#praiseFloatBtn, #praiseFloatBtnMd").removeClass("with-badge")
        $('#praiseFloatBtn, #praiseFloatBtnMd').removeAttr("badge")
        $('#praiseDesc').text('çœŸè¯šç‚¹èµï¼Œè¯šä¸æˆ‘æ¬º');
      }
    });
  }

  // ç‚¹èµ
  $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").on('click', function () {
    praiseFunc();
  });

  // æ”¶è—
  let collectionCount = [[${ vo.article.count.collectionCount }]]
  let collected = [[${ vo.article.collected }]]

  $("#collectFloatBtn, #collectFloatBtnMd").click(function () {
    if (!isLogin) {
      // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
      return;
    }

    collected = !collected;
    const curDom = $(this)
    collectArticle(articleId, collected, function (data) {
      if (collected) {
        // ç‚¹èµ
        collectionCount += 1;
        curDom.addClass("active")
      } else {
        collectionCount -= 1;
        curDom.removeClass("active")
      }

      if (collectionCount > 0) {
        curDom.addClass("with-badge")
        curDom.attr("badge", collectionCount)
      } else {
        curDom.removeClass("with-badge")
        curDom.removeAttr("badge")
      }
    });
  })


  // åŠ è½½æ¨èåˆ—è¡¨
  let params = {
    "articleId": articleId,
    "page": 1
  }
  loadMore("#articleList", "/article/api/recommend", params, "articleList", function () {
    if ($('#articleList:has(div)').length == 0) {
      // ä¸å­˜åœ¨æ¨èå†…å®¹
      $("#relatedRecommend").hide();
    }
  });

  // å›åˆ°é¡¶ç«¯
  $.scrollUp({
    animation: 'fade',
    activeOverlay: '#00FFFF',
    scrollImg: {
      active: true,
      type: 'background',
      src: '/img/top.png'
    }
  });

  function bindCommentInputEvent() {
    // ç›´æ¥è¯„è®º
    const commentContent = $("#commentContent")
    const commentBtn = $("#commentBtn")
    commentBtn.click(function () {
      const content = commentContent.val()
      if (!content || content.length > 512) {
        toastr.error("è¯„è®ºå†…å®¹é•¿åº¦è¦æ±‚åœ¨[1,512]ä¹‹é—´")
        return
      }
      // æäº¤è¯„è®º
      const params = {
        // æ–‡ç« id
        articleId: articleId,
        // è¯„è®ºå†…å®¹
        commentContent: content,
      }
      post("/comment/api/post", params, function (data) {
        // ä½¿ç”¨ Ajax çš„æ–¹å¼ï¼Œç›´æ¥æ›´æ–°è¯„è®ºåˆ—è¡¨
        document.getElementById("commentDiv").innerHTML = data
        bindCommentInputEvent()
      })
    });

    // ç›´æ¥è¯„è®ºç›‘å¬
    $(document).on("input propertychange", "#commentContent", function () {
      const val = $(this).val()
      console.log(val)
      if (val) {
        $("#commentBtn").attr("disabled", false).removeClass("c-btn-disabled")
      } else {
        $("#commentBtn").attr("disabled", true).addClass("c-btn-disabled")
      }
    })
  }

  // å›å¤
  $(document).on("click", ".reply-comment", function () {
    const currentDom = $(this)
    createComment(currentDom)
  })

  // å›å¤ç¼–è¾‘
  $(document).on("click", ".hf-pl", function () {
    const currentDom = $(this)
    commentSubmit(currentDom)
  })

  $(document).on("input propertychange", ".hf-input", function () {
    const currentDom = $(this)
    listenCommentBtn(currentDom)
  })

  // ç‚¹å‡»å›å¤åˆ›å»ºè¯„è®º
  const createComment = function (currentDom) {
    // ç§»é™¤å…¶ä»–å›å¤
    $(".hf-con").remove()

    // è·å–å›å¤äººçš„åå­—
    var fhName = currentDom
            .parents(".common-item-content")
            .find(".comment-name")
            .html()
    //å›å¤@
    var fhN = "å›å¤@" + fhName + "ï¼š"
    var fhHtml =
            '<div class="hf-con pull-left"><textarea class="hf-input" placeholder="" "></textarea><button disabled class="hf-pl hf-pl--disabled">è¯„è®º</button></div>'
    if (currentDom.is(".hf-con-block")) {
      const currentWrap =
              (currentDom.parents(".comment-item-wrap").length &&
                      currentDom.parents(".comment-item-wrap")) ||
              (currentDom.parents(".comment-item-wrap-second").length &&
                      currentDom.parents(".comment-item-wrap-second"))

      currentWrap.find(".common-item-content").append(fhHtml)
      currentDom.removeClass("hf-con-block")
      //inputæ¡†è‡ªåŠ¨èšç„¦
      currentDom
              .parents(".common-item-content")
              .find(".hf-input")
              .val("")
              .focus()
              .attr("placeholder", fhN)
      // å–æ¶ˆå›å¤
      currentDom.find(".reply-comment-text").hide()
      currentDom.find(".reply-comment-text-none").show()
    } else {
      currentDom.addClass("hf-con-block")
      currentDom.parents(".common-item-content").find(".pull-left").remove()
      // å›å¤
      currentDom.find(".reply-comment-text").show()
      currentDom.find(".reply-comment-text-none").hide()
    }
  }

  // è¯„è®ºç¼–è¾‘&æäº¤
  const commentSubmit = function (currentDom) {
    const replyContent = currentDom.siblings(".hf-input")
    const replyBtn = currentDom
            .parents(".common-item-content")
            .find(".reply-comment")

    if (!replyContent.val()) {
      toastr.error("å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º")
      return
    }
    // æäº¤è¯„è®º
    const params = {
      // æ–‡ç« id
      articleId: $("#postsTitle").attr("data-id"),
      // è¯„è®ºå†…å®¹
      commentContent: replyContent.val(),
      // å›å¤çš„è¯„è®ºid
      parentCommentId: replyBtn.attr("data-reply-id"),
      // å›å¤çš„ä¸€çº§è¯„è®ºid
      topCommentId: replyBtn.attr("data-reply-top"),
    }
    post("/comment/api/post", params, function (data) {
      document.getElementById("commentDiv").innerHTML = data
      bindCommentInputEvent();
    })
  }

  // ç›‘å¬æŒ‰é’®
  const listenCommentBtn = function (currentDom) {
    if (!currentDom.val()) {
      $(".hf-pl").attr("disabled", true).addClass("hf-pl--disabled")
    } else {
      $(".hf-pl").attr("disabled", false).removeClass("hf-pl--disabled")
    }
  }


  bindCommentInputEvent();

  function copyAndClose() {
    // å¤åˆ¶çŸ­é“¾
    copyShortUrl();
    // // å…³é—­å¼¹çª—ï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œå…³é—­ä¹‹åæ— æ³•å†æ¬¡æ‰“å¼€ï¼›å…ˆä¸å…³é—­
    // $('#shareModal').hide();
  }
  /*]]>*/
</script>
</body>

</html>