<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
    <title th:text="${vo.article.title} + '-æŠ€æœ¯æ´¾'">æŠ€æœ¯æ´¾</title>
  </div>

  <link rel="stylesheet" href="/css/views/article-detail.css" th:href="${global.siteInfo.oss + '/css/views/article-detail.css'}" />
  <script src="/js/marked.min.js" th:src="${global.siteInfo.oss + '/js/marked.min.js'}"></script>
  <script src="/js/biz/selection.js" th:src="${global.siteInfo.oss + '/js/biz/selection.js'}"></script>
  <script src="/js/biz/highlightcomment.js" th:src="${global.siteInfo.oss + '/js/biz/highlightcomment.js'}"></script>
  <script src="/js/biz/ai-comment.js" th:src="${global.siteInfo.oss + '/js/biz/ai-comment.js'}"></script>
  <script src="/js/biz/comment-markdown.js" th:src="${global.siteInfo.oss + '/js/biz/comment-markdown.js'}"></script>

  <body id="body" class="bg-color">
    <!-- å¯¼èˆªæ  -->
    <div th:replace="components/layout/navbar :: navbar"></div>

    <div class="home article-detail">
      <div class="col-body pg-2-article">
        <div class="com-3-layout">
          <div class="layout-main">
            <!-- å·¦è¾¹ç‚¹èµã€æ”¶è—ã€è¯„è®ºæµ®çª— -->
            <div
              th:replace="views/article-detail/side-float-action-bar/index :: tool_bar(${vo.article})"
            ></div>

            <!-- æ­£æ–‡ -->
            <div
              th:replace="components/article/article-detail :: article_info(${vo.article}, ${vo.author}, ${vo.other}, ${vo.payUsers})"
            ></div>

            <!--  è¯„è®º  -->
            <div id="commentDiv">
              <div th:replace="views/article-detail/comment/index"></div>
            </div>

            <div
              class="correlation-article bg-color-white"
              id="relatedRecommend"
            >
              <!-- å…³è”æ¨è -->
              <h4 class="correlation-article-title">ç›¸å…³æ¨è</h4>
              <div class="bg-color-white">
                <div id="articleList"></div>
              </div>
            </div>
          </div>

          <div class="layout-side">
            <!-- ç”¨æˆ·ç›¸å…³ä¿¡æ¯ -->
            <div
              th:replace="components/user/user-card :: user_card(${vo.author}, ${vo.article.author}, ${global.isLogin})"
            ></div>

            <!-- æ´»åŠ¨æ¨è -->
            <div th:if="${!#lists.isEmpty(vo.sideBarItems)}">
              <div th:replace="views/article-detail/side-recommend-bar/index">
                ä¾§è¾¹é€šçŸ¥æ¿å—
              </div>
            </div>
            <div id="toc-container-position"></div>
            <!-- æ–‡ç« ç›®å½•  -->
            <div class="right-container toc-container">
              <div class="widget">
                <h3 class="com-nav-bar-title">ç›®å½•</h3>
                <div id="contentMenu" class="toc"></div>
              </div>
            </div>

            <!-- å¼•ç”¨è¯„è®ºä¾§è¾¹æ  -->
            <div id="quoteCommentSidebar" class="right-container quote-comment-sidebar" style="display: none;">
              <div class="widget">
                <h3 class="com-nav-bar-title">åˆ’è¯è¯„è®º</h3>
                <div class="quote-content">
                  <div class="quote-text" id="quotedText"></div>
                  <div class="quote-comment-form comment-input-container">
                    <textarea id="quoteCommentInput" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." class="form-control"></textarea>

                    <div class="comment-toolbar">
                      <div class="toolbar-left">
                        <div class="ai-bot-selector" id="aiBotSelector">
                          <button type="button" class="ai-bot-btn" id="aiBotBtn">
                            ğŸ¤–
                          </button>
                          <div class="ai-bot-dropdown" id="aiBotDropdown" style="top: 100%; bottom: auto;">
                            <div class="ai-bot-option" data-bot="hater">æ ç²¾æ´¾</div>
                            <div class="ai-bot-option" data-bot="smart">æ´¾èªæ˜</div>
                          </div>
                        </div>
                      </div>
                      <div class="toolbar-right">
                        <span class="comment-count"><span id="commentCount">0</span>/512</span>
                        <button id="submitQuoteComment" class="c-btn c-btn-primary mt-2" disabled>æäº¤è¯„è®º</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨ä¿¡æ¯ -->
      <div th:replace="components/layout/footer :: footer"></div>
    </div>

    <!-- å·¦è¾¹ç‚¹èµã€æ”¶è—ã€è¯„è®ºæµ®çª— -->
    <div
      th:replace="views/article-detail/side-float-action-bar-md/index :: tool_bar(${vo.article})"
    ></div>

    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">åˆ†äº«æ–‡ç« </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <div class="qrcode-container mb-3">
              <img id="shareQrCode" src="" alt="åˆ†äº«äºŒç»´ç " style="width:200px;height:200px;">
            </div>
            <div class="short-url-container">
              <div class="input-group">
                <input type="text" id="shortUrl" class="form-control" readonly style="font-size: 1rem;">
                <div class="input-group-append">
                  <button class="btn btn-outline-secondary" type="button" onclick="copyAndClose()">å¤åˆ¶</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¼•ç”¨è¯„è®ºå¼¹çª— (ç§»åŠ¨ç«¯) -->
    <div class="modal fade" id="quoteCommentModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">å¼•ç”¨è¯„è®º</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="quote-content">
              <div class="quote-text" id="quotedTextModal"></div>
              <div class="quote-comment-form">
                <textarea id="quoteCommentInputModal" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." class="form-control"></textarea>
                <button id="submitQuoteCommentModal" class="c-btn c-btn-primary mt-2" disabled>æäº¤è¯„è®º</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      /*<![CDATA[*/
      // å†…å®¹æ¸²æŸ“
      const articleId = [[${vo.article.articleId}]];

      // ç”Ÿæˆèœå•
      genTocMenu('#articleContent', '#contentMenu');

      // è·³è½¬åˆ°è¯„è®ºçš„åœ°æ–¹
      $("#commentFloatBtn,#commentFloatBtnMd").click(function () {
          document.getElementById("commentList").scrollIntoView(true);
      })

      if (window.location.href.indexOf("#commentList") >= 0) {
          document.getElementById("commentList").scrollIntoView(true);
      }

      // ç‚¹èµ
      let praisedCount = [[${vo.article.count.praiseCount}]]
      let praised = [[${vo.article.praised}]]
      const isLogin = [[${global.isLogin}]]
      const currentUserId = isLogin ? [[${global.user != null ? global.user.userId: ''}]] : '';
      const currentUserAvatar = isLogin ? [[${global.user != null ? global.user.photo: ''}]] : '';

      // ä¸ºé€‰ä¸­çš„æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
      const highlightComments = [[${vo.highlightComments}]];
      console.log('highlightComments:', highlightComments)
      if (highlightComments) {
        // åˆå§‹åŒ–æ–‡ç« çš„ä¸‹åˆ’çº¿æ ·å¼
        initUnderlineToSelection(highlightComments);
      }

      function praiseFunc() {
          if (!isLogin) {
              // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
              return;
          }

          praised = !praised;

          praiseArticle(articleId, praised, function (data) {
              let avatarList = $('#praiseUsers')
              if (praised) {
                  // ç‚¹èµ
                  praisedCount += 1;
                  $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").addClass("active")

                  // æ·»åŠ å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
                  avatarList.prepend('' +
                      '            <a class="g-user-popover approval-img" href="/user/' + currentUserId + '">\n' +
                      '                <img src="' + currentUserAvatar + '">\n' +
                      '            </a>')
              } else {
                  // å–æ¶ˆç‚¹èµ
                  praisedCount -= 1;
                  $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").removeClass("active")

                  // ç§»é™¤å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
                  let subItems = avatarList.children();
                  for (let i = 0; i < subItems.length; i++) {
                      let target = subItems[i];
                      if (target.innerHTML.indexOf(currentUserAvatar) >= 0) {
                          // ç§»é™¤å½“å‰ç”¨æˆ·å¤´åƒ
                          target.remove();
                          break;
                      }
                  }
              }


              if (praisedCount > 0) {
                  $("#praiseFloatBtn, #praiseFloatBtnMd").addClass("with-badge")
                  $('#praiseFloatBtn, #praiseFloatBtnMd').attr("badge", praisedCount)
                  $('#praiseDesc').text(String(praisedCount) + 'äººå·²ç‚¹èµ');

              } else {
                  $("#praiseFloatBtn, #praiseFloatBtnMd").removeClass("with-badge")
                  $('#praiseFloatBtn, #praiseFloatBtnMd').removeAttr("badge")
                  $('#praiseDesc').text('çœŸè¯šç‚¹èµï¼Œè¯šä¸æˆ‘æ¬º');
              }
          });
      }

      // ç‚¹èµ
      $("#praiseFloatBtn, #praiseBtn, #praiseFloatBtnMd").on('click', function () {
          praiseFunc();
      });

      // æ”¶è—
      let collectionCount = [[${vo.article.count.collectionCount}]]
      let collected = [[${vo.article.collected}]]

      $("#collectFloatBtn, #collectFloatBtnMd").click(function () {
          if (!isLogin) {
              // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
              return;
          }

          collected = !collected;
          const curDom = $(this)
          collectArticle(articleId, collected, function (data) {
              if (collected) {
                  // ç‚¹èµ
                  collectionCount += 1;
                  curDom.addClass("active")
              } else {
                  collectionCount -= 1;
                  curDom.removeClass("active")
              }

              if (collectionCount > 0) {
                  curDom.addClass("with-badge")
                  curDom.attr("badge", collectionCount)
              } else {
                  curDom.removeClass("with-badge")
                  curDom.removeAttr("badge")
              }
          });
      })


      // åŠ è½½æ¨èåˆ—è¡¨
      let params = {
          "articleId": articleId,
          "page": 1
      }
      loadMore("#articleList", "/article/api/recommend", params, "articleList", function() {
        if($('#articleList:has(div)').length == 0) {
          // ä¸å­˜åœ¨æ¨èå†…å®¹
          $("#relatedRecommend").hide();
        }
      });

      // å›åˆ°é¡¶ç«¯
      $.scrollUp({
          animation: 'fade',
          activeOverlay: '#00FFFF',
          scrollImg: {
              active: true,
              type: 'background',
              src: '/img/top.png'
          }
      });

      function bindCommentInputEvent() {
        // ç›´æ¥è¯„è®º
        const commentContent = $("#commentContent")
        const commentBtn = $("#commentBtn")
        commentBtn.click(function () {
          const content = commentContent.val()
          if (!content || content.length > 512) {
            toastr.error("è¯„è®ºå†…å®¹é•¿åº¦è¦æ±‚åœ¨[1,512]ä¹‹é—´")
            return
          }
          // æäº¤è¯„è®º
          const params = {
            // æ–‡ç« id
            articleId: articleId,
            // è¯„è®ºå†…å®¹
            commentContent: content,
          }
          post("/comment/api/post", params, function (data) {
            // ä½¿ç”¨ Ajax çš„æ–¹å¼ï¼Œç›´æ¥æ›´æ–°è¯„è®ºåˆ—è¡¨
            document.getElementById("commentDiv").innerHTML = data
            bindCommentInputEvent()
          })
        });

        // ç›´æ¥è¯„è®ºç›‘å¬
        $(document).on("input propertychange", "#commentContent", function () {
          const val = $(this).val()
          console.log(val)
          if (val) {
            $("#commentBtn").attr("disabled", false).removeClass("c-btn-disabled")
          } else {
            $("#commentBtn").attr("disabled", true).addClass("c-btn-disabled")
          }
        })
      }

      // å›å¤
      $(document).on("click", ".reply-comment", function () {
        const currentDom = $(this)
        createComment(currentDom)
      })

      // å›å¤ç¼–è¾‘
      $(document).on("click", ".hf-pl", function () {
        const currentDom = $(this)
        commentSubmit(currentDom)
      })

      $(document).on("input propertychange", ".hf-input", function () {
        const currentDom = $(this)
        listenCommentBtn(currentDom)
      })

      // ç‚¹å‡»å›å¤åˆ›å»ºè¯„è®º
      const createComment = function (currentDom) {
        // ç§»é™¤å…¶ä»–å›å¤
        $(".hf-con").remove()

        // è·å–å›å¤äººçš„åå­—
        var fhName = currentDom
                .parents(".common-item-content")
                .find(".comment-name")
                .html()
        //å›å¤@
        var fhN = "å›å¤@" + fhName + "ï¼š"
        var fhHtml =
                '<div class="hf-con pull-left"><textarea class="hf-input" placeholder="" "></textarea><button disabled class="hf-pl hf-pl--disabled">è¯„è®º</button></div>'
        if (currentDom.is(".hf-con-block")) {
          const currentWrap =
                  (currentDom.parents(".comment-item-wrap").length &&
                          currentDom.parents(".comment-item-wrap")) ||
                  (currentDom.parents(".comment-item-wrap-second").length &&
                          currentDom.parents(".comment-item-wrap-second"))

          currentWrap.find(".common-item-content").append(fhHtml)
          currentDom.removeClass("hf-con-block")
          //inputæ¡†è‡ªåŠ¨èšç„¦
          currentDom
                  .parents(".common-item-content")
                  .find(".hf-input")
                  .val("")
                  .focus()
                  .attr("placeholder", fhN)
          // å–æ¶ˆå›å¤
          currentDom.find(".reply-comment-text").hide()
          currentDom.find(".reply-comment-text-none").show()
        } else {
          currentDom.addClass("hf-con-block")
          currentDom.parents(".common-item-content").find(".pull-left").remove()
          // å›å¤
          currentDom.find(".reply-comment-text").show()
          currentDom.find(".reply-comment-text-none").hide()
        }
      }

      // è¯„è®ºç¼–è¾‘&æäº¤
      const commentSubmit = function (currentDom) {
        const replyContent = currentDom.siblings(".hf-input")
        const replyBtn = currentDom
                .parents(".common-item-content")
                .find(".reply-comment")

        if (!replyContent.val()) {
          toastr.error("å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º")
          return
        }
        // æäº¤è¯„è®º
        const params = {
          // æ–‡ç« id
          articleId: $("#postsTitle").attr("data-id"),
          // è¯„è®ºå†…å®¹
          commentContent: replyContent.val(),
          // å›å¤çš„è¯„è®ºid
          parentCommentId: replyBtn.attr("data-reply-id"),
          // å›å¤çš„ä¸€çº§è¯„è®ºid
          topCommentId: replyBtn.attr("data-reply-top"),
        }
        post("/comment/api/post", params, function (data) {
          // å¯¹äºä¾§è¾¹æ çš„è¯„è®ºå›å¤
          if (replyBtn.attr("data-reply-top")) {
            // åˆ·æ–°ä¾§è¾¹çš„å¼•ç”¨è¯„è®ºå†…å®¹
            showQuoteCommentWithComments(replyBtn.attr("data-reply-top"));
          }

          // åˆ·æ–°åº•éƒ¨è¯„è®ºçš„å›å¤
          document.getElementById("commentDiv").innerHTML = data
          bindCommentInputEvent();
        })
      }

      // ç›‘å¬æŒ‰é’®
      const listenCommentBtn = function (currentDom) {
        if (!currentDom.val()) {
          $(".hf-pl").attr("disabled", true).addClass("hf-pl--disabled")
        } else {
          $(".hf-pl").attr("disabled", false).removeClass("hf-pl--disabled")
        }
      }


      bindCommentInputEvent();

      function copyAndClose() {
        // å¤åˆ¶çŸ­é“¾
        copyShortUrl();
        // // å…³é—­å¼¹çª—ï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œå…³é—­ä¹‹åæ— æ³•å†æ¬¡æ‰“å¼€ï¼›å…ˆä¸å…³é—­
        // $('#shareModal').hide();
      }
      /*]]>*/
    </script>
  </body>
</html>
