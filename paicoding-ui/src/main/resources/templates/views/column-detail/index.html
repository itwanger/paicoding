<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
  <div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
    <title th:text="${vo.article.title  + ' - ' + global.siteInfo.websiteName}">
      ä¸“æ å†…å®¹è¯¦æƒ…é¡µ | æŠ€æœ¯æ´¾
    </title>
  </div>

  <link rel="stylesheet" href="/css/views/column-detail.css" th:href="${global.siteInfo.oss + '/css/views/column-detail.css'}" />
  <script src="/js/marked.min.js" th:src="${global.siteInfo.oss + '/js/marked.min.js'}"></script>
  <script src="/js/biz/selection.js" th:src="${global.siteInfo.oss + '/js/biz/selection.js'}"></script>
  <script src="/js/biz/highlightcomment.js" th:src="${global.siteInfo.oss + '/js/biz/highlightcomment.js'}"></script>
  <script src="/js/biz/ai-comment.js" th:src="${global.siteInfo.oss + '/js/biz/ai-comment.js'}"></script>
  <script src="/js/biz/comment-markdown.js" th:src="${global.siteInfo.oss + '/js/biz/comment-markdown.js'}"></script>

  <body id="body" data-copy-limit="200" data-copy-limit-scope="#articleContent" data-copy-limit-exempt="pre,code">
    <!-- å¯¼èˆªæ  -->
    <div th:replace="components/layout/navbar :: navbar"></div>
    <div class="article-wrap">
        <!-- ç›®å½• -->
        <div th:replace="views/column-detail/column-menu/index"></div>
        <!-- å†…å®¹ -->
        <div class="article-content-wrap bg-color">
          <!--  å¢åŠ ä¸€ä¸ªæœç´¢çš„ Form è¡¨å•å’Œå·¦ä¾§ç›®å½•æŠ˜å çš„æŒ‰é’®  -->
          <div class="for-menu">
            <form class="bd-search d-flex align-items-center">
              <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
              <!-- æŠ˜å ä¸“æ ç›®å½•æŒ‰é’® -->
              <button class="btn bd-search-docs-toggle d-md-none pl-1 pr-0"
                      type="button"
                      data-toggle="collapse"
                      data-target="#collapseMenu"
                      aria-controls="collapseMenu"
                      aria-expanded="false"
                      aria-label="Toggle docs navigation"
                      th:data-toggle-tooltip="tooltip"
                      title="å±•å¼€/æ”¶èµ·ä¸“æ ç›®å½•">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false">
                  <title>ä¸“æ ç›®å½•</title>
                  <path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"/>
                </svg>
                <span class="d-md-none ml-1" style="font-size: 12px;">ä¸“æ </span>
              </button>
              <!-- æŠ˜å æ–‡ç« å†…å®¹å¯¼èˆªæŒ‰é’® -->
              <button class="btn bd-toc-toggle d-md-none pl-1 pr-0 ml-2"
                      type="button"
                      data-toggle="collapse"
                      data-target="#contentMenuCollapse"
                      aria-controls="contentMenuCollapse"
                      aria-expanded="false"
                      aria-label="Toggle table of contents"
                      th:data-toggle-tooltip="tooltip"
                      title="å±•å¼€/æ”¶èµ·æ–‡ç« ç›®å½•">
                <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <title>æ–‡ç« ç›®å½•</title>
                  <path d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
                <span class="d-md-none ml-1" style="font-size: 12px;">ç›®å½•</span>
              </button>
            </form>
          </div>

          <!--  æ­£æ–‡ -->
          <div class="article-content-inter-wrap">
            <div th:replace="components/article/article-detail :: article_info(${vo.article}, null, ${vo.other}, ${vo.payUsers})"></div>
            <!--  è¯„è®º  -->
            <div id="commentDiv">
              <div th:replace="components/comment/comment-list :: comment_list(${vo.hotComment}, ${vo.comments}, ${vo.article})"
              >
                è¯„è®ºåˆ—è¡¨
              </div>
            </div>
          </div>

          <!-- æ–‡ç« å†…å®¹å¯¼èˆª -->
          <div class="right-container toc-container column collapse d-md-block toc-responsive layout-side">
            <div class="right-container">
              <div id="toc-container-position" class="right-container"></div>
              <div class="right-container toc-container column collapse d-md-block toc-responsive" id="contentMenuCollapse">
                <div class="widget rounded ">
                  <h3 class="com-nav-bar-title">ç›®å½•</h3>
                  <div id="contentMenu" class="toc toc-sticky"></div>
                </div>
              </div>
            </div>

            <!-- å¼•ç”¨è¯„è®ºä¾§è¾¹æ  -->
            <div id="quoteCommentSidebar" class="right-container quote-comment-sidebar" style="display: none;">
              <div class="widget">
                <h3 class="com-nav-bar-title">åˆ’è¯è¯„è®º</h3>
                <div class="quote-content">
                  <div class="quote-text" id="quotedText"></div>
                  <div class="quote-comment-form comment-input-container">
                    <textarea id="quoteCommentInput" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." class="form-control"></textarea>

                    <div class="comment-toolbar">
                      <div class="toolbar-left">
                        <div class="ai-bot-selector" id="aiBotSelector">
                          <button type="button" class="ai-bot-btn" id="aiBotBtn">
                            ğŸ¤–
                          </button>
                          <div class="ai-bot-dropdown" id="aiBotDropdown" style="top: 100%; bottom: auto;">
                            <div class="ai-bot-option" data-bot="hater">æ ç²¾æ´¾</div>
                            <div class="ai-bot-option" data-bot="smart">æ´¾èªæ˜</div>
                          </div>
                        </div>
                      </div>
                      <div class="toolbar-right">
                        <span class="comment-count"><span id="commentCount">0</span>/512</span>
                        <button id="submitQuoteComment" class="c-btn c-btn-primary mt-2" disabled>æäº¤è¯„è®º</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    <!--   æ–‡ç« åˆ†äº«æ¨¡æ€æ¡†   -->
    <div class="modal fade" id="shareModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">åˆ†äº«æ–‡ç« </h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body text-center">
            <div class="qrcode-container mb-3">
              <img id="shareQrCode" src="" alt="åˆ†äº«äºŒç»´ç ">
            </div>
            <div class="short-url-container">
              <div class="input-group" style="max-width: 500px; margin: 0 auto;">
                <input type="text" id="shortUrl" class="form-control" readonly >
                <div class="input-group-append">
                  <button class="btn btn-primary" type="button" onclick="copyAndClose()">å¤åˆ¶</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å¼•ç”¨è¯„è®ºå¼¹çª— (ç§»åŠ¨ç«¯) -->
    <div class="modal fade" id="quoteCommentModal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">å¼•ç”¨è¯„è®º</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="quote-content">
              <div class="quote-text" id="quotedTextModal"></div>
              <div class="quote-comment-form">
                <textarea id="quoteCommentInputModal" placeholder="å†™ä¸‹æ‚¨çš„è¯„è®º..." class="form-control"></textarea>
                <button id="submitQuoteCommentModal" class="c-btn c-btn-primary mt-2" disabled>æäº¤è¯„è®º</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </body>

  <script th:inline="javascript">
    // menu æ˜¯å¦æ˜¾ç¤º
    function checkMediaQuery() {
      if (window.matchMedia('(min-width: 700px)').matches) {
        // å¦‚æœå±å¹•å®½åº¦å¤§äº600pxï¼Œæ·»åŠ  'show' ç±»
        $('#collapseMenu').addClass('show');
      } else {
        // å¦åˆ™ï¼Œç§»é™¤ 'show' ç±»
        $('#collapseMenu').removeClass('show');
      }
    }

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    $(window).resize(checkMediaQuery);

    // åˆå§‹æ£€æŸ¥
    checkMediaQuery();

    // menu æ»šåŠ¨åˆ°æŒ‡å®šä½ç½®
    function scrollToMenu() {
      const sectiona = $("a.active.section");
      if (sectiona.length > 0) {
        sectiona[0].scrollIntoView({
          behavior: "smooth",
          block: "center",
          inline: "center",
        });
      }
    }

    $('#collapseMenu').on('shown.bs.collapse', function () {
      scrollToMenu();
    })

    scrollToMenu();

    // å†…å®¹æ¸²æŸ“
    const articleId = [[${ vo.article.articleId }]];

    // è·³è½¬åˆ°è¯„è®ºçš„åœ°æ–¹
    $("#commentFloatBtn").click(function () {
      document.getElementById("commentList").scrollIntoView(true);
    })

    // ç‚¹èµ
    let praisedCount = [[${ vo.article.count.praiseCount }]]
    let praised = [[${ vo.article.praised }]]
    const isLogin = [[${ global.isLogin }]]
    const currentUserId = isLogin ? [[${ global.user != null ? global.user.userId : '' }]] : '';
    const currentUserAvatar = isLogin ? [[${ global.user != null ? global.user.photo : '' }]] : '';


    // ä¸ºé€‰ä¸­çš„æ–‡æœ¬æ·»åŠ ä¸‹åˆ’çº¿æ ·å¼
    const highlightComments = [[${vo.highlightComments}]];
    console.log('highlightComments:', highlightComments)
    if (highlightComments) {
      // åˆå§‹åŒ–æ–‡ç« çš„ä¸‹åˆ’çº¿æ ·å¼
      initUnderlineToSelection(highlightComments);
    }


    $("#praiseBtn").on('click', function () {
      if (!isLogin) {
        // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
        return;
      }
      praised = !praised;
      praiseArticle(articleId, praised, function (data) {
        let avatarList = $('#praiseUsers')
        if (praised) {
          // ç‚¹èµ
          praisedCount += 1;
          $("#praiseBtn").addClass("active")

          // æ·»åŠ å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
          avatarList.prepend('' +
            '            <a class="g-user-popover approval-img" href="/user/' + currentUserId + '">\n' +
            '                <img src="' + currentUserAvatar + '">\n' +
            '            </a>')
        } else {
          // å–æ¶ˆç‚¹èµ
          praisedCount -= 1;
          $("#praiseBtn").removeClass("active")

          // ç§»é™¤å½“å‰ç‚¹èµç”¨æˆ·çš„å¤´åƒ
          let subItems = avatarList.children();
          for (let i = 0; i < subItems.length; i++) {
            let target = subItems[i];
            if (target.innerHTML.indexOf(currentUserAvatar) >= 0) {
              // ç§»é™¤å½“å‰ç”¨æˆ·å¤´åƒ
              target.remove();
              break;
            }
          }
        }
        if (praisedCount > 0) {
          $('#praiseDesc').text(String(praisedCount) + 'äººå·²ç‚¹èµ');
        } else {
          $('#praiseDesc').text('çœŸè¯šç‚¹èµï¼Œè¯šä¸æˆ‘æ¬º');
        }
      });
    });

    // æ”¶è—
    let collectionCount = [[${ vo.article.count.collectionCount }]]
    let collected = [[${ vo.article.collected }]]
    $("#collectFloatBtn").click(function () {
      if (!isLogin) {
        // æœªç™»å½•ï¼Œä¸æ‰§è¡Œç›¸å…³æ“ä½œ
        return;
      }

      collected = !collected;

      collectArticle(articleId, collected, function (data) {
        if (collected) {
          // ç‚¹èµ
          collectionCount += 1;
          $("#collectFloatBtn").addClass("active")
        } else {
          collectionCount -= 1;
          $("#collectFloatBtn").removeClass("active")
        }

        if (collectionCount > 0) {
          $("#collectFloatBtn").addClass("with-badge")
          $('#collectFloatBtn').attr("badge", collectionCount)
        } else {
          $("#collectFloatBtn").removeClass("with-badge")
          $('#collectFloatBtn').removeAttr("badge")
        }
      });
    })

    // äºŒç»´ç 
    $("#qrIconTag").click(function () {
      const tag = $("#qrTipsTag")
      if (tag.hasClass("show")) {
        tag.removeClass("show")
      } else {
        tag.addClass("show")
      }
    })

    function bindCommentInputEvent() {
      // ç›´æ¥è¯„è®º
      const commentContent = $("#commentContent")
      const commentBtn = $("#commentBtn")
      commentBtn.click(function () {
        const content = commentContent.val()
        if (!content || content.length > 512) {
          toastr.error("è¯„è®ºå†…å®¹é•¿åº¦è¦æ±‚åœ¨[1,512]ä¹‹é—´")
          return
        }
        // æäº¤è¯„è®º
        const params = {
          // æ–‡ç« id
          articleId: articleId,
          // è¯„è®ºå†…å®¹
          commentContent: content,
        }
        post("/comment/api/post", params, function (data) {
          // ä½¿ç”¨ Ajax çš„æ–¹å¼ï¼Œç›´æ¥æ›´æ–°è¯„è®ºåˆ—è¡¨
          document.getElementById("commentDiv").innerHTML = data
          bindCommentInputEvent()
        })
      })

      // ç›´æ¥è¯„è®ºç›‘å¬
      $(document).on("input propertychange", "#commentContent", function () {
        const val = $(this).val()
        console.log(val)
        if (val) {
          $("#commentBtn").attr("disabled", false).removeClass("c-btn-disabled")
        } else {
          $("#commentBtn").attr("disabled", true).addClass("c-btn-disabled")
        }
      })
    }

    // å›å¤
    $(document).on("click", ".reply-comment", function () {
      const currentDom = $(this)
      createComment(currentDom)
    })

    // å›å¤ç¼–è¾‘
    $(document).on("click", ".hf-pl", function () {
      const currentDom = $(this)
      commentSubmit(currentDom)
    })

    $(document).on("input propertychange", ".hf-input", function () {
      const currentDom = $(this)
      listenCommentBtn(currentDom)
    })

    // ç‚¹å‡»å›å¤åˆ›å»ºè¯„è®º
    const createComment = function (currentDom) {
      // ç§»é™¤å…¶ä»–å›å¤
      $(".hf-con").remove()

      // è·å–å›å¤äººçš„åå­—
      var fhName = currentDom
        .parents(".common-item-content")
        .find(".comment-name")
        .html()
      //å›å¤@
      var fhN = "å›å¤@" + fhName + "ï¼š"
      var fhHtml =
        '<div class="hf-con pull-left"><textarea class="hf-input" placeholder="" "></textarea><button disabled class="hf-pl hf-pl--disabled">è¯„è®º</button></div>'
      if (currentDom.is(".hf-con-block")) {
        const currentWrap =
          (currentDom.parents(".comment-item-wrap").length &&
            currentDom.parents(".comment-item-wrap")) ||
          (currentDom.parents(".comment-item-wrap-second").length &&
            currentDom.parents(".comment-item-wrap-second"))

        currentWrap.find(".common-item-content").append(fhHtml)
        currentDom.removeClass("hf-con-block")
        //inputæ¡†è‡ªåŠ¨èšç„¦
        currentDom
          .parents(".common-item-content")
          .find(".hf-input")
          .val("")
          .focus()
          .attr("placeholder", fhN)
        // å–æ¶ˆå›å¤
        currentDom.find(".reply-comment-text").hide()
        currentDom.find(".reply-comment-text-none").show()
      } else {
        currentDom.addClass("hf-con-block")
        currentDom.parents(".common-item-content").find(".pull-left").remove()
        // å›å¤
        currentDom.find(".reply-comment-text").show()
        currentDom.find(".reply-comment-text-none").hide()
      }
    }

    // è¯„è®ºç¼–è¾‘&æäº¤
    const commentSubmit = function (currentDom) {
      const replyContent = currentDom.siblings(".hf-input")
      const replyBtn = currentDom
        .parents(".common-item-content")
        .find(".reply-comment")

      if (!replyContent.val()) {
        toastr.error("å›å¤å†…å®¹ä¸èƒ½ä¸ºç©º")
        return
      }
      // æäº¤è¯„è®º
      const params = {
        // æ–‡ç« id
        articleId: $("#postsTitle").attr("data-id"),
        // è¯„è®ºå†…å®¹
        commentContent: replyContent.val(),
        // å›å¤çš„è¯„è®ºid
        parentCommentId: replyBtn.attr("data-reply-id"),
        // å›å¤çš„ä¸€çº§è¯„è®ºid
        topCommentId: replyBtn.attr("data-reply-top"),
      }
      post("/comment/api/post", params, function (data) {
        // å¯¹äºä¾§è¾¹æ çš„è¯„è®ºå›å¤
        if (replyBtn.attr("data-reply-top")) {
          // åˆ·æ–°ä¾§è¾¹çš„å¼•ç”¨è¯„è®ºå†…å®¹
          showQuoteCommentWithComments(replyBtn.attr("data-reply-top"));
        }

        document.getElementById("commentDiv").innerHTML = data
        bindCommentInputEvent()
      })
    }

    // ç›‘å¬æŒ‰é’®
    const listenCommentBtn = function (currentDom) {
      if (!currentDom.val()) {
        $(".hf-pl").attr("disabled", true).addClass("hf-pl--disabled")
      } else {
        $(".hf-pl").attr("disabled", false).removeClass("hf-pl--disabled")
      }
    }

    // åˆ†ç»„å±•å¼€/æ”¶ç¼©åŠŸèƒ½
    const initGroupToggle = function() {
      // ä½¿ç”¨Mapå­˜å‚¨åˆ†ç»„çŠ¶æ€
      const groupStates = new Map();
      
      // è·å–å½“å‰æ¿€æ´»çš„æ–‡ç« æ‰€åœ¨åˆ†ç»„
      const $activeSection = $('.section.active');
      const activeGroupName = $activeSection.attr('data-group');
      
      // éšè—æ‰€æœ‰åˆ†ç»„ä¸‹çš„æ–‡ç« ï¼ˆé™¤äº†å½“å‰æ¿€æ´»æ–‡ç« æ‰€åœ¨çš„åˆ†ç»„ï¼‰
      $('.section[data-group]').each(function() {
        const $section = $(this);
        const groupName = $section.attr('data-group');
        
        if (groupName && groupName !== 'æœªåˆ†ç»„') {
          // åˆå§‹åŒ–åˆ†ç»„çŠ¶æ€
          // å¦‚æœæ˜¯å½“å‰æ¿€æ´»æ–‡ç« æ‰€åœ¨çš„åˆ†ç»„ï¼Œåˆ™é»˜è®¤å±•å¼€ï¼ˆçŠ¶æ€ä¸ºtrueï¼‰ï¼Œå¦åˆ™é»˜è®¤æ”¶ç¼©ï¼ˆçŠ¶æ€ä¸ºfalseï¼‰
          const isActiveGroup = (groupName === activeGroupName);
          groupStates.set(groupName, isActiveGroup);
          
          // è®¾ç½®é»˜è®¤æ˜¾ç¤º/éšè—çŠ¶æ€
          if (!isActiveGroup) {
            $section.hide();
          }
        }
      });
      
      // å±•å¼€å½“å‰æ¿€æ´»æ–‡ç« æ‰€åœ¨çš„åˆ†ç»„ï¼ˆæ›´æ–°ç®­å¤´çŠ¶æ€ï¼‰
      if (activeGroupName && activeGroupName !== 'æœªåˆ†ç»„') {
        $(`.group-header[data-group="${activeGroupName}"]`).find('.group-toggle').addClass('expanded');
      }
      
      // ä¸ºæ‰€æœ‰åˆ†ç»„æ ‡é¢˜æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜æé«˜æ€§èƒ½ï¼‰
      $(document).on('click', '.group-header', function() {
        const $header = $(this);
        const $toggle = $header.find('.group-toggle');
        const groupName = $header.attr('data-group');
        
        // è·å–å½“å‰çŠ¶æ€å¹¶å–å
        const currentState = groupStates.get(groupName) || false;
        const newState = !currentState;
        
        // æ›´æ–°çŠ¶æ€å’ŒUI
        groupStates.set(groupName, newState);
        $toggle.toggleClass('expanded', newState);
        
        // æ‰¹é‡æ“ä½œDOMï¼Œå‡å°‘é‡æ’
        requestAnimationFrame(() => {
          $(`.section[data-group="${groupName}"]`).toggle(newState);
        });
      });
      
      // åˆå§‹çŠ¶æ€è®¾ç½® - ç§»é™¤æ²¡æœ‰åœ¨å½“å‰æ¿€æ´»åˆ†ç»„ä¸­çš„å…¶ä»–åˆ†ç»„çš„expandedç±»
      $('.group-header:not([data-group="' + activeGroupName + '"]) .group-toggle').removeClass('expanded');
    }

    // æ›´æ–°æµè§ˆå™¨æ ‡ç­¾é¡µæ ‡é¢˜
    const updatePageTitle = function() {
      // è·å–å½“å‰æ–‡ç« æ ‡é¢˜
      const currentArticleTitle = $('.section.active .title-text').text();
      // è·å–ä¸“æ åç§°ï¼ˆé€šè¿‡æŸ¥æ‰¾ä¸“æ ç›®å½•ä¸­ä»»æ„æ–‡ç« çš„data-groupå±æ€§ï¼Œç„¶åæ‰¾åˆ°å¯¹åº”çš„åˆ†ç»„æ ‡é¢˜ï¼‰
      let columnName = '';
      const $groupHeader = $('.group-header').first();
      if ($groupHeader.length > 0) {
        columnName = $groupHeader.find('.group-name').text();
      }
      
      if (currentArticleTitle && columnName) {
        // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸º"æ–‡ç« æ ‡é¢˜ - ä¸“æ åç§° - ç½‘ç«™åç§°"çš„æ ¼å¼
        document.title = currentArticleTitle + ' - ' + columnName + ' - ' + [[${global.siteInfo.websiteName}]];
      } else if (currentArticleTitle) {
        // å¦‚æœæ²¡æœ‰ä¸“æ åç§°ï¼Œè‡³å°‘æ˜¾ç¤ºæ–‡ç« æ ‡é¢˜
        document.title = currentArticleTitle + ' - ' + [[${global.siteInfo.websiteName}]];
      }
    }

    // ç”Ÿæˆå†…å®¹å¯¼èˆªèœå•
    function generateTocMenu() {
      const tocContainer = $('.toc-container');
      if (tocContainer.length > 0) {
        const tocMenu = $('#contentMenu');
        // è·å–æ–‡ç« å†…å®¹ä¸­çš„æ‰€æœ‰æ ‡é¢˜ï¼Œæ’é™¤modal-dialogä¸­çš„æ ‡é¢˜
        const contentHeadings = $('.article-info-wrap').find('h1, h2, h3, h4, h5, h6').not('.modal-dialog h1, .modal-dialog h2, .modal-dialog h3, .modal-dialog h4, .modal-dialog h5, .modal-dialog h6');

        if (contentHeadings.length > 0) {
          let tocHtml = '<ul class="markdown-toc-list">';
          let lastLevel = 0;

          contentHeadings.each(function() {
            const $heading = $(this);
            const level = parseInt(this.tagName.charAt(1));
            const text = $heading.text();
            const id = $heading.attr('id') || ('heading-' + text.replace(/\s+/g, '-').toLowerCase());

            // ä¸ºæ ‡é¢˜æ·»åŠ idå±æ€§
            $heading.attr('id', id);

            // æ„å»ºå¯¼èˆªèœå•HTML
            if (level > lastLevel) {
              tocHtml += '<ul>';
            } else if (level < lastLevel) {
              tocHtml += '</li></ul></li>';
            } else {
              tocHtml += '</li>';
            }

            // æ·»åŠ ä¸åŒçº§åˆ«çš„æ ‡é¢˜ç±»å
            if (level === 2) {
              tocHtml += `<li><a class="toc-level-${level} toc-h2" href="#${id}" level="${level}">${text}</a>`;
            } else if (level === 3) {
              tocHtml += `<li><a class="toc-level-${level} toc-h3" href="#${id}" level="${level}">${text}</a>`;
            } else {
              tocHtml += `<li><a class="toc-level-${level}" href="#${id}" level="${level}">${text}</a>`;
            }
            lastLevel = level;
          });

          tocHtml += '</li></ul>';
          tocMenu.html(tocHtml);
          tocContainer.show();
          
          // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
          bindTocScrollSpy();
        } else {
          tocContainer.hide();
        }
      }
    }
    
    // ç»‘å®šæ»šåŠ¨ç›‘å¬å’Œç‚¹å‡»äº‹ä»¶ä»¥æ›´æ–°ç›®å½•é€‰ä¸­çŠ¶æ€
    function bindTocScrollSpy() {
      // ä¸ºç›®å½•é“¾æ¥æ·»åŠ ç‚¹å‡»äº‹ä»¶
      $('#contentMenu a').on('click', function(e) {
        e.preventDefault();
        // ç§»é™¤æ‰€æœ‰ç°æœ‰é€‰ä¸­çŠ¶æ€
        $('#contentMenu a').removeClass('active');
        // ä¸ºå½“å‰ç‚¹å‡»çš„é“¾æ¥æ·»åŠ é€‰ä¸­çŠ¶æ€
        $(this).addClass('active');

        // æ»šåŠ¨åˆ°å¯¹åº”çš„å†…å®¹åŒºåŸŸ
        const targetId = $(this).attr('href').substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth' });
        }
        
        // åœ¨å°å±å¹•è®¾å¤‡ä¸Šï¼Œç‚¹å‡»ç›®å½•é¡¹åè‡ªåŠ¨æŠ˜å å†…å®¹å¯¼èˆª
        if (window.matchMedia('(max-width: 991px)').matches) {
          $('#contentMenuCollapse').collapse('hide');
          // è°ƒæ•´å†…å®¹å®½åº¦
          adjustContentWidth();
        }
      });

      // ç›‘å¬çª—å£æ»šåŠ¨äº‹ä»¶ä»¥è‡ªåŠ¨æ›´æ–°é€‰ä¸­çŠ¶æ€
      $(window).on('scroll', function() {
        updateTocActiveState();
      });

      // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸€æ¬¡é€‰ä¸­çŠ¶æ€
      updateTocActiveState();
    }
    
    // æ›´æ–°ç›®å½•çš„æ´»åŠ¨çŠ¶æ€
    function updateTocActiveState() {
      const scrollPosition = $(window).scrollTop() + 100; // æ·»åŠ åç§»é‡ä»¥æ›´å‡†ç¡®åŒ¹é…

      // ç§»é™¤æ‰€æœ‰ç°æœ‰é€‰ä¸­çŠ¶æ€
      $('#contentMenu a').removeClass('active');

      // æŸ¥æ‰¾å½“å‰è§†å£ä¸­çš„æ ‡é¢˜
      let currentHeadingId = '';
      $('.article-info-wrap :header[id]').each(function() {
        const headingTop = $(this).offset().top;
        if (headingTop <= scrollPosition) {
          currentHeadingId = $(this).attr('id');
        }
      });

      // ä¸ºå¯¹åº”çš„ç›®å½•é¡¹æ·»åŠ é€‰ä¸­çŠ¶æ€
      if (currentHeadingId) {
        $('#contentMenu a[href="#' + currentHeadingId + '"]').addClass('active');
      }

      // æ›´æ–°ç›®å½•å®¹å™¨æ»šåŠ¨ä½ç½®
      const tocContainer = $('.toc-container');
      const activeLink = $('#contentMenu a.active');
      if (activeLink.length > 0) {
        const activeLinkTop = activeLink.offset().top - tocContainer.offset().top + tocContainer.scrollTop();
        tocContainer.scrollTop(activeLinkTop - tocContainer.height() / 2);
      }
    }

    $(document).ready(function () {
      // ç”Ÿæˆå†…å®¹å¯¼èˆªèœå•
      generateTocMenu();
      
      // æ£€æŸ¥å±å¹•å°ºå¯¸å¹¶åˆå§‹åŒ–ç§»åŠ¨ç«¯å†…å®¹å¯¼èˆª
      checkTocMediaQuery();
      $(window).resize(checkTocMediaQuery);
      
      // ç›‘å¬å†…å®¹å¯¼èˆªçš„æŠ˜å /å±•å¼€äº‹ä»¶
      $('#contentMenuCollapse').on('shown.bs.collapse', function () {
        // å†…å®¹å¯¼èˆªå±•å¼€æ—¶çš„å¤„ç†
        adjustContentWidth();
      }).on('hidden.bs.collapse', function () {
        // å†…å®¹å¯¼èˆªéšè—æ—¶çš„å¤„ç†
        adjustContentWidth();
      });
      
      // åˆå§‹åŒ–å·¥å…·æç¤º
      $('[data-toggle="tooltip"]').tooltip();
    });

    bindCommentInputEvent()
    initGroupToggle()

    // æ£€æŸ¥å±å¹•å°ºå¯¸å¹¶å¤„ç†å†…å®¹å¯¼èˆªæ˜¾ç¤ºçŠ¶æ€
    function checkTocMediaQuery() {
      const tocContainer = $('.toc-container');
      if (window.matchMedia('(min-width: 992px)').matches) {
        // å¤§å±å¹•è®¾å¤‡ï¼Œæ˜¾ç¤ºå†…å®¹å¯¼èˆª
        tocContainer.addClass('d-md-block').removeClass('collapse');
        tocContainer.css('display', ''); // æ¸…é™¤å¯èƒ½çš„display: none
      } else {
        // å°å±å¹•è®¾å¤‡ï¼Œç¡®ä¿å†…å®¹å¯¼èˆªæ˜¯æŠ˜å çš„
        tocContainer.removeClass('d-md-block').addClass('collapse');
        // å¦‚æœä¹‹å‰æ˜¯å±•å¼€çŠ¶æ€ï¼Œéœ€è¦éšè—
        if (tocContainer.hasClass('show')) {
          tocContainer.collapse('hide');
        }
      }
      // è°ƒæ•´å†…å®¹å®½åº¦
      adjustContentWidth();
    }
    
    // è°ƒæ•´æ­£æ–‡å†…å®¹å®½åº¦
    function adjustContentWidth() {
      const tocContainer = $('.toc-container');
      const contentWrap = $('.article-content-inter-wrap');
      
      if (window.matchMedia('(min-width: 992px)').matches) {
        // å¤§å±å¹•è®¾å¤‡ï¼Œä¿ç•™å³è¾¹è·ä¸ºç›®å½•ç•™å‡ºç©ºé—´
        contentWrap.css('margin-right', '300px');
      } else {
        // å°å±å¹•è®¾å¤‡ï¼Œå³è¾¹è·è®¾ä¸º0ä»¥å……åˆ†åˆ©ç”¨å±å¹•ç©ºé—´
        contentWrap.css('margin-right', '0');
      }
    }

    function copyAndClose() {
      // å¤åˆ¶çŸ­é“¾
      copyShortUrl();
      // // å…³é—­å¼¹çª—ï¼Œæœ‰ä¸ªé—®é¢˜ï¼Œå…³é—­ä¹‹åæ— æ³•å†æ¬¡æ‰“å¼€ï¼›å…ˆä¸å…³é—­
      // $('#shareModal').hide();
    }
  </script>
</html>
