<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:replace="components/layout/header :: head(~{::title}, ~{}, ~{})">
  <title th:text="${global.siteInfo.websiteName}">æŠ€æœ¯æ´¾ - æ–‡ç« å‘è¡¨</title>
</div>

<link rel="stylesheet" href="/editormd/css/editormd.css" th:href="${global.siteInfo.oss + '/editormd/css/editormd.css'}" />
<link rel="stylesheet" href="/css/views/article-edit.css" th:href="${global.siteInfo.oss + '/css/views/article-edit.css'}" />
<script src="/editormd/editormd.js" th:src="${global.siteInfo.oss + '/editormd/editormd.js'}"></script>
<!-- ğŸ”¥ Moveable åº“ï¼ˆå›¾ç‰‡ç¼©æ”¾åŠŸèƒ½ä¾èµ–ï¼‰ -->
<script src="/js/lib/moveable.min.js" th:src="${global.siteInfo.oss + '/js/lib/moveable.min.js'}"></script>
<!-- ğŸ”¥ å›¾ç‰‡æ‹–æ‹½ç¼©æ”¾æ¨¡å— -->
<script src="/js/biz/editor-image-resize.js" th:src="${global.siteInfo.oss + '/js/biz/editor-image-resize.js'}"></script>

<body id="body">
<!-- æ­£æ–‡å†…å®¹ -->
<div class="edit-nav">
  <form action="/save" method="get" class="edit-title-form">
    <input
            id="titleInput"
            type="text"
            class="edit-title-input"
            th:value="${vo.article != null ? vo.article.title: ''}"
            placeholder="è¾“å…¥æ–‡ç« æ ‡é¢˜..."
            oninput="showSaveBtnByTitle()"
    />
  </form>
  <div class="edit-save">
    <span>ä¿ å­˜</span>
  </div>
  <div class="dropdown">
    <img
            class="nav-login-img dropdown-toggle"
            data-toggle="dropdown"
            th:src="${global.user.photo}"
    />
    <!-- ä¸‹æ‹‰æ¡† -->
    <div class="dropdown-menu nav-login-menu">
      <div
              th:if="${#strings.equalsIgnoreCase(global.user.role, 'admin')}"
              class="dropdown-divider"
      ></div>
      <a
              th:href="${'/user/home?userId=' + (global.user?.userId ?: '')}"
              class="dropdown-item"
              href="#"
      >
        ä¸ªäººä¸»é¡µ
      </a>
      <a id="logoutBtn" href="/logout" class="dropdown-item">ç™»å‡º</a>
    </div>
  </div>
</div>
<div class="form-group" id="paiEditor">
      <textarea
              style="display: none"
              th:text="${vo.article != null ? vo.article.content: ''}"
      ></textarea>
</div>

<div
        class="modal fade"
        id="saveModel"
        role="dialog"
        tabindex="-1"
        aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å‘å¸ƒæ–‡ç« </h5>
        <button
                type="button"
                class="close"
                data-dismiss="modal"
                aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="edit-sort-wrap form-group category required">
          <label class="form-label">åˆ†ç±»:</label>
          <div class="form-selectgroup">
            <label
                    th:each="category : ${vo.categories}"
                    th:class="'form-selectgroup-item ' + ${category.selected ? 'form-selectgroup-item--active': ''}"
            >
              <input
                      type="radio"
                      name="category"
                      th:value="${category.categoryId}"
                      th:checked="${category.selected}"
                      class="form-selectgroup-input"
              />
              <span
                      class="form-selectgroup-label"
                      th:text="${category.category}"
              >
                    åç«¯
                  </span>
            </label>
          </div>
        </div>

        <div class="form-group edit-tag-wrap required">
          <label class="form-label">æ·»åŠ æ ‡ç­¾:</label>
          <select id="tag-select" class="form-control" multiple="multiple">
            <option
                    th:each="tag : ${vo.tags}"
                    th:text="${tag.tag}"
                    th:value="${tag.tagId}"
                    selected="selected"
            ></option>
          </select>
        </div>

        <div class="edit-sort-wrap form-group category required">
          <label class="form-label">é˜…è¯»ç±»å‹:</label>
          <div class="form-selectgroup">
            <label class="r-form-selectgroup-item form-selectgroup-item--active"
                   th:class="'r-form-selectgroup-item ' + ${vo.article == null || (vo.article != null && vo.article.readType == 0) ? 'form-selectgroup-item--active': ''}">
              <input type="radio" name="readType" value="0" th:checked="${vo.article == null || (vo.article != null && vo.article.readType == 0)}" class="form-selectgroup-input"/>
              <span class="form-selectgroup-label">å…¨éƒ¨å¯è¯»</span>
            </label>
            <label class="r-form-selectgroup-item"
                   th:class="'r-form-selectgroup-item ' + ${vo.article != null && vo.article.readType == 1 ? 'form-selectgroup-item--active': ''}">
              <input type="radio" name="readType" value="1" th:checked="${vo.article!= null && vo.article.readType == 1}"  class="form-selectgroup-input"/>
              <span class="form-selectgroup-label">ç™»å½•é˜…è¯»</span>
            </label>
            <label class="r-form-selectgroup-item"
                   th:class="'r-form-selectgroup-item ' + ${vo.article != null && vo.article.readType == 4 ? 'form-selectgroup-item--active': ''}">
              <input type="radio" name="readType" value="4" th:checked="${vo.article != null && vo.article.readType == 4}"  class="form-selectgroup-input"/>
              <span class="form-selectgroup-label">ä»˜è´¹é˜…è¯»</span>
            </label>
            <label class="r-form-selectgroup-item"
                   th:class="'r-form-selectgroup-item ' + ${vo.article != null && vo.article.readType == 3 ? 'form-selectgroup-item--active': ''}">
              <input type="radio" name="readType" value="3" th:checked="${vo.article != null && vo.article.readType == 3}" class="form-selectgroup-input"/>
              <span class="form-selectgroup-label">æ˜Ÿçƒä¸“äº«</span>
            </label>
          </div>
        </div>
        <!--    æ”¯ä»˜é˜…è¯»ç›¸å…³é…ç½®        -->
        <div id="payReader">
          <div class="form-group">
            <label class="form-label">æ”¯ä»˜æ–¹å¼:</label>
            <label class="form-selectgroup">
              <label class="radio-inline">
                <input type="radio"  name="payWay" id="payWay1" value="email"/>
                <label for="payWay1">ä¸ªäººæ”¶æ¬¾ç </label>
              </label>
              <label class="radio-inline" style="margin-left: 1em;">
                <input type="radio"  name="payWay" id="payWay2" value="wx_native" checked/>
                <label for="payWay2" id="wxPayWayLabel">ç»Ÿä¸€å¾®ä¿¡æ”¯ä»˜</label>
              </label>
            </label>
          </div>
          <div id="tips" style="font-size: 0.8em;color: gray;text-align: left;margin: -1em 2em 1em 2em;background-color: #f3f3f3;padding: 1em">
            <div id="emailPayTip">
              <div class="form-group" th:if="${#strings.isEmpty(global.user.payCode)}">
                <div style="font-size: 1.3em;color: red;text-align: center;">é…ç½®æ”¶æ¬¾ç ä¹‹åæ‰å¯ä»¥é€‰æ‹©ä»˜è´¹é˜…è¯»å“¦~<a style="color: blue" th:href="'/user/home?userId=' + ${global.user != null ? global.user.userId : ''}" target="_blank">å»é…ç½®</a></div>
              </div>
              <h5 style="margin-left: 4em;font-size: 1.2em;color: #363645">ä¸ªäººæ”¶æ¬¾ç è¯´æ˜:</h5>
              <ul style="margin-left: 6em">
                <li style="list-style-type: circle;">
                  åœ¨ä¸ªäººä¸­å¿ƒç»´æŠ¤ä¸ªäººçš„å¾®ä¿¡/æ”¯ä»˜å®/QQæ”¶æ¬¾ç ï¼Œç”¨æˆ·æ‰“èµç›´æ¥åˆ°ä½œè€…è´¦å·
                </li>
                <li  style="list-style-type: circle;">
                  ä½œè€…é€šè¿‡é‚®ç®±æ¥æ”¶æ‰“èµç¡®è®¤é‚®ä»¶ï¼Œæ ¹æ®æ˜¯å¦åˆ°è´¦é€‰æ‹©ç¡®è®¤æ”¶æ¬¾æˆ–æœªæ”¶æ¬¾
                </li>
              </ul>
            </div>
            <div id="wxPayTip">
              <h5 style="margin-left: 4em;font-size: 1.2em;color: #363645">å¾®ä¿¡æ”¯ä»˜è¯´æ˜:</h5>
              <ul style="margin-left: 6em">
                <li  style="list-style-type: circle;">é€šè¿‡å¾®ä¿¡æ‰«ä¸€æ‰«å®ç°æ–‡ç« ä»˜è´¹ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ¤æ–­æ”¯ä»˜æˆåŠŸå¤±è´¥ï¼›</li>
                <li  style="list-style-type: circle;">ç”¨æˆ·æ”¯ä»˜é‡‘é¢å…ˆæ±‡æ€»åˆ°æŠ€æœ¯æ´¾è´¦å·ï¼Œåå°å†ç»Ÿä¸€ç»™ä½œè€…è¿›è¡Œåˆ†è´¦</li>
              </ul>
            </div>
          </div>
          <div class="input-group" id="payAmount">
            <label class="form-label">ä»˜è´¹(å…ƒï¿¥):</label>
            <input id="payAmountVal" th:value="${vo.article == null ? 0.99 : (vo.article['payAmount'] == null ? 0.99 : vo.article['payAmount'])}" type="number" style="border: 1px solid #ced4da;border-radius: .25rem;width: 70%;height: calc(1.5em + .75rem + 2px);padding: .375rem .75rem;" >
          </div>

        </div>

        <div class="input-group cover">
          <label class="form-label">æ–‡ç« å°é¢:</label>
          <div class="custom-file">
            <div class="person-img-inter-wrap">
              <div class="click-cover">
                <svg
                        t="1670660402857"
                        class="icon"
                        viewBox="0 0 1024 1024"
                        version="1.1"
                        xmlns="http://www.w3.org/2000/svg"
                        p-id="2974"
                        width="16"
                        height="16"
                >
                  <path
                          d="M782.72512 327.9104l-242.54464-242.54464a35.84512 35.84512 0 0 0-13.76256-10.7008c-0.22016-0.09728-0.44032-0.2048-0.67072-0.30208a33.97632 33.97632 0 0 0-13.34272-2.73408l-0.08704 0.00512-0.32256-0.01536c-0.09216 0-0.1792 0.01536-0.27136 0.01536-0.09728 0-0.18944-0.01536-0.2816-0.01536a33.7664 33.7664 0 0 0-20.21376 6.66624 35.96288 35.96288 0 0 0-6.79936 6.27712l-243.3536 243.36384c-6.97856 6.97856-10.85952 15.97952-11.0848 25.4208a35.4304 35.4304 0 0 0 9.3696 24.9344l0.512 0.512a34.49344 34.49344 0 0 0 24.01792 9.57952 36.5568 36.5568 0 0 0 26.33728-11.29472L476.16 191.14496v499.99872a35.84 35.84 0 1 0 71.68 0v-499.8144l185.73312 185.73312c6.97856 6.97856 15.97952 10.85952 25.41568 11.0848l0.86016 0.01024c9.1136 0 17.60768-3.43552 24.07936-9.37984l0.512-0.512c13.30176-13.83424 12.76928-36.38272-1.7152-50.3552z"
                          fill="#ffffff"
                          p-id="2975"
                  ></path>
                  <path
                          d="M880.64 747.57632v61.44c0 39.58784-32.09216 71.68-71.68 71.68H215.04c-39.58784 0-71.68-32.09216-71.68-71.68v-61.44a35.84 35.84 0 1 0-71.68 0v61.44c0 79.17568 64.18432 143.36 143.36 143.36h593.92c79.17568 0 143.36-64.18432 143.36-143.36v-61.44a35.84 35.84 0 1 0-71.68 0z"
                          fill="#ffffff"
                          p-id="2976"
                  ></path>
                </svg>
                <div class="click-text">ç‚¹å‡»ä¸Šä¼ å°é¢</div>
              </div>
              <img class="person-img" id="pic" />
              <span class="close_icon">X</span>

              <svg
                      t="1670660844412"
                      class="upload-icon-up"
                      viewBox="0 0 1029 1024"
                      version="1.1"
                      xmlns="http://www.w3.org/2000/svg"
                      p-id="3248"
                      width="24"
                      height="24"
              >
                <path
                        d="M661.23 1003.042H119.672c-64.034 0-116.053-51.883-116.053-115.712V115.917C3.618 52.224 55.638 0.068 119.671 0.068H893.27c63.898 0 115.985 52.02 115.985 115.849v539.99c0 21.23-17.34 38.775-38.707 38.775s-38.912-17.34-38.912-38.776v-539.99c0-21.23-17.34-38.638-38.57-38.638H119.67c-21.299 0-38.912 17.408-38.912 38.639v771.14c0 21.231 17.613 38.639 38.912 38.639h541.492c21.162 0 38.707 17.203 38.707 38.639 0.068 21.3-17.545 38.707-38.64 38.707z"
                        fill="#bfbfbf"
                        p-id="3249"
                ></path>
                <path
                        d="M42.325 771.755c-9.762 0-19.729-4.028-27.238-11.606-14.95-14.95-14.95-39.458 0-54.408l192.785-192.034c35.157-35.158 89.156-44.169 133.803-21.777L551.39 596.65c14.814 7.578 32.768 4.643 44.373-7.167l347.614-346.317c14.95-15.019 39.458-15.019 54.682 0 15.223 14.882 15.087 39.39 0 54.545l-347.75 346.317c-35.09 35.089-88.816 43.759-133.667 21.367L306.86 561.084c-14.95-7.578-32.7-4.506-44.374 7.168L69.7 760.012c-7.51 7.578-17.34 11.743-27.375 11.743zM351.71 385.775c-63.898 0-116.053-51.746-116.053-115.712 0-63.898 51.882-115.712 116.053-115.712 63.76 0 116.053 51.883 116.053 115.712 0 63.898-52.36 115.712-116.053 115.712z m0-154.146c-21.163 0-38.776 17.271-38.776 38.502 0 21.368 17.477 38.64 38.776 38.64 21.163 0 38.639-17.272 38.639-38.64 0-21.23-17.34-38.502-38.64-38.502zM834.833 1024c-21.367 0-38.844-17.203-38.844-38.775V753.869c0-21.095 17.204-38.64 38.844-38.64 21.163 0 38.776 17.34 38.776 38.64v231.356c-0.069 21.572-17.545 38.775-38.776 38.775z"
                        fill="#bfbfbf"
                        p-id="3250"
                ></path>
                <path
                        d="M989.389 868.284c-9.49 0-18.978-3.345-26.76-10.377l-127.864-120.15-128.478 120.15c-15.36 14.404-39.8 13.858-54.409-1.57-14.677-15.633-13.994-39.868 1.707-54.682L788.89 674.611c11.127-13.721 27.58-21.436 45.533-21.436 17.818 0 34.27 7.988 45.261 21.436l135.441 127.044c15.702 14.814 16.52 38.912 1.775 54.682-6.758 7.782-17.066 11.947-27.511 11.947z"
                        fill="#bfbfbf"
                        p-id="3251"
                ></path>
              </svg>
              <input
                      type="file"
                      accept="image/*"
                      id="upload"
                      class="click-input"
              />
            </div>
          </div>
        </div>
        <div class="input-group input-textarea required">
          <label class="form-label">æ–‡ç« æ‘˜è¦:</label>
          <textarea
                  id="summary"
                  class="form-control form-textarea summary"
                  data-bs-toggle="autosize"
                  placeholder="æ‘˜è¦ï¼ˆå¿…å¡«ï¼‰ï¼šä¼šåœ¨æ¨èã€åˆ—è¡¨ç­‰åœºæ™¯å¤–éœ²ï¼Œå¸®åŠ©è¯»è€…å¿«é€Ÿäº†è§£å†…å®¹ï¼Œæ”¯æŒä¸€é”®å°†æ­£æ–‡å‰ 256 å­—ç¬¦é”®å…¥æ‘˜è¦æ–‡æœ¬æ¡†"
                  maxlength="256"
                  th:text="${vo.article != null ?  vo.article.summary: ''}"
                  oninput="initSummary()"
          ></textarea>
          <span
                  class="form-textarea-limit"
                  th:text="${vo.article != null ?  #strings.length(vo.article.summary) + '/256': '0/256'}"
          >
                0/128
              </span>
          <button
                  type="button"
                  class="el-button btn-getdistill el-button--default el-button--mini is-round"
          >
            <span>ä¸€é”®æå–</span>
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="publish" type="button" class="btn btn-primary">
          å‘å¸ƒ
        </button>
        <button id="tmpSave" type="button" class="btn btn-secondary">
          å­˜è‰ç¨¿
        </button>
      </div>
    </div>
  </div>
</div>

<div class="edit-mask">
  <img src="/img/icon.png" class="edit-mask-img" alt="" th:src="${global.siteInfo.oss + '/img/icon.png'}">
  <span>æ–‡ä»¶è§£æä¸­...</span>
</div>


<script th:inline="javascript">
  // ä¸€äº› jQuery å¯¹è±¡
  let pic = $("#pic"),tagSelect = $('#tag-select'),
          upload = $("#upload"), clickCover = $(".click-cover"),
          titleInput = $('#titleInput'), categoryLabel = $('.form-selectgroup-item'),
          editBtn = $('.edit-save'),close_icon = $(".close_icon"), readTypeLabel = $('.r-form-selectgroup-item');
  let userPayCode = [[${global.user.payCode}]]

  // ä¸€äº›å˜é‡
  let vo = [[${ vo }]];
  console.log("å®Œæ•´çš„æ–‡ç« å‚æ•°: ", vo);
  let uid = "forumId", articleId = 0,
          cover =[[${ vo.article != null ? vo.article.cover : '' }]],
          showSaveBtnFlagByTitle = false;

  // æ ¡éªŒé™åˆ¶ï¼Œå¦‚æ ‡é¢˜é•¿åº¦[5,120], å†…å®¹å¿…é¡»>=6ï¼Œç®€ä»‹æœ€å¤š 256å­—ç¬¦
  const titleMin = 5, titleMax = 120,
          contentMin = 6, summaryMax = 256;

  if (vo && vo.article) {
    articleId = vo.article.articleId;
    uid = uid + "_" + articleId;
  }

  // å·²çŸ¥çš„å‚æ•°
  let defaults = {
    articleId: articleId,
    articleType: "BLOG",
    source: 2,
    sourceUrl: "",
    cover: cover,
  };

  // å±•ç¤ºé®ç½©
  const showMask = () => {
    const editMaskDom =  $(".edit-mask")
    const isVisible = editMaskDom.is(':visible')
    console.log({isVisible});
    if(!isVisible){
      editMaskDom.css('display','flex')
    }
  }

  // éšè—é®ç½©
  const hideMask = () => {
    const editMaskDom =  $(".edit-mask")
    const isVisible = editMaskDom.is(':visible')
    if(isVisible){
      editMaskDom.hide()
    }
  }

  const preprocessMarkdown = (markdown) => {
    const regex = /(#+) \*\*(.+?)\*\*/g;
    return markdown.replace(regex, (match, p1, p2) => `${p1} ${p2}`);
  };

  // ç¼–è¾‘å™¨
  // oss è·¯å¾„
  const oss = [[${global.siteInfo.oss}]];
  const jspath = oss + '/editormd/lib/';
  let simplemde = editormd("paiEditor", {
    path: jspath,
    width: "100%",
    height: calculateEditorHeight(),
    katexURL : {
      css : oss + "/katex/katex",
      js : oss + "/katex/katex",

    }, // KaTeX çš„åŸºæœ¬ URL
    // autoHeight : true,
    // theme : "dark",
    // previewTheme : "dark",
    // editorTheme : "pastel-on-dark",
    // markdown : md.result,
    codeFold: true,
    //syncScrolling : false,
    saveHTMLToTextarea: true,    // ä¿å­˜ HTML åˆ° Textarea
    searchReplace: true,
    //watch : false,                // å…³é—­å®æ—¶é¢„è§ˆ
    htmlDecode: true,            // å¼€å¯ HTML æ ‡ç­¾è§£æï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œé»˜è®¤ä¸å¼€å¯
    //toolbar  : false,             //å…³é—­å·¥å…·æ 
    //previewCodeHighlight : false, // å…³é—­é¢„è§ˆ HTML çš„ä»£ç å—é«˜äº®ï¼Œé»˜è®¤å¼€å¯
    emoji: true,
    taskList: true,
    tocm: true,         // Using [TOCM]
    tex: true,                   // å¼€å¯ç§‘å­¦å…¬å¼TeXè¯­è¨€æ”¯æŒï¼Œé»˜è®¤å…³é—­
    flowChart: true,             // å¼€å¯æµç¨‹å›¾æ”¯æŒï¼Œé»˜è®¤å…³é—­
    sequenceDiagram: true,       // å¼€å¯æ—¶åº/åºåˆ—å›¾æ”¯æŒï¼Œé»˜è®¤å…³é—­,
    //dialogLockScreen : false,   // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†ä¸é”å±ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
    //dialogShowMask : false,     // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†æ˜¾ç¤ºé€æ˜é®ç½©å±‚ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
    //dialogDraggable : false,    // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†ä¸å¯æ‹–åŠ¨ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
    //dialogMaskOpacity : 0.4,    // è®¾ç½®é€æ˜é®ç½©å±‚çš„é€æ˜åº¦ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤å€¼ä¸º0.1
    //dialogMaskBgColor : "#000", // è®¾ç½®é€æ˜é®ç½©å±‚çš„èƒŒæ™¯é¢œè‰²ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸º#fff

    // è‡ªå®šä¹‰èœå•
    toolbarIcons: function () {
      return [
        "mdFile","|",
        "undo", "redo", "|",
        "bold", "del", "italic", "quote", "ucwords", "uppercase", "lowercase", "|",
        "h1", "h2", "h3", "h4", "|",
        "list-ul", "list-ol", "hr", "|",
        "reference-link", "image", "video", "code", "code-block", "table", "html-entities", "|",
        "goto-line", "watch", "fullscreen", "clear", "search", "|",
        "help"
      ]
    },

    // ç”¨äºå¢åŠ è‡ªå®šä¹‰å·¥å…·æ çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥æ’å…¥HTMLæ ‡ç­¾ï¼Œä¸ä½¿ç”¨é»˜è®¤çš„å…ƒç´ åˆ›å»ºå›¾æ ‡
    toolbarIconTexts : {
      mdFile : "å¯¼å…¥MD",
      video : "<i class='fa fa-film'></i>"
    },
    toolbarHandlers: {
      mdFile : function(cm, icon, cursor, selection){
        console.log("å¯¼å…¥MD");
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.accept = ".md";
        fileInput.onchange = function(){
          console.log("æ–‡ä»¶é€‰æ‹©å®Œæ¯•");

          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = function(e){
            // è·å–æ–‡ä»¶å†…å®¹
            let content = e.target.result;
            console.log("æ–‡ä»¶å†…å®¹ï¼š", content);

            // å¦‚æœå†…å®¹ä¸ºç©ºçš„è¯ï¼Œç›´æ¥è¿”å›
            if(!content || content.length <= 0) {
              return;
            }

            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ‰¾åˆ°å‰ä¸¤ä¸ª "â€”" åˆ†éš”ç¬¦ä¹‹é—´çš„å†…å®¹ï¼Œä»¥åŠç¬¬äºŒä¸ª "â€”" åˆ†éš”ç¬¦ä¹‹åçš„å†…å®¹
            let match = content.match(/^-{3,}([\s\S]*?)-{3,}([\s\S]*)/);
            if (match && match[1] && match[2]) {
              // æå–æ ‡é¢˜
              let titleMatch = match[1].match(/title: (.*)/);
              let title = titleMatch && titleMatch[1] ? titleMatch[1].trim() : null;

              if (title) {
                console.log("æ ‡é¢˜ï¼š", title);
                $("#titleInput").val(title);
                showSaveBtnByTitle();
              } else {
                console.error("æ²¡æœ‰æ‰¾åˆ°æ ‡é¢˜");
              }

              // æå–æè¿°
              let descMatch = match[1].match(/description: ([^\n]*)/);
              let summary = descMatch && descMatch[1] ? descMatch[1].trim() : null;

              if (summary) {
                console.log("æè¿°ï¼š", summary);
                $("#summary").val(summary);
              } else {
                console.error("æ²¡æœ‰æ‰¾åˆ°æè¿°");
              }

              let text = match[2].trim();
              console.log("æ­£æ–‡ï¼š", text);

              // æ’å…¥åˆ°ç¼–è¾‘å™¨
              content = text;
            } else {
              cm.replaceSelection(content);
            }

            cm.replaceSelection(preprocessMarkdown(content));

          };
          reader.readAsText(file);
        };
        fileInput.click();
      },
      video : function(cm, icon, cursor, selection){
        console.log("æ’å…¥è§†é¢‘");

        // åˆ›å»ºä¸€ä¸ªç¾åŒ–çš„å¼¹çª—
        const dialogHtml = `
          <div class="video-dialog-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
            <div class="video-dialog-content" style="background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
              <h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: 600;">æ’å…¥è§†é¢‘</h3>
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #666;">è§†é¢‘å¹³å°ï¼š</label>
                <select id="videoPlatform" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                  <option value="bilibili">Bç«™ï¼ˆBilibiliï¼‰</option>
                  <option value="youtube">YouTube</option>
                  <option value="tencent">è…¾è®¯è§†é¢‘</option>
                </select>
              </div>
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #666;">è§†é¢‘é“¾æ¥æˆ–IDï¼š</label>
                <input type="text" id="videoUrl" placeholder="ç²˜è´´è§†é¢‘é“¾æ¥æˆ–BVå·" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />
                <div style="margin-top: 8px; font-size: 12px; color: #999;">
                  <div id="platformTip">æ”¯æŒæ ¼å¼ï¼šhttps://www.bilibili.com/video/BV1xx411c7mD æˆ–ç›´æ¥è¾“å…¥ BV1xx411c7mD</div>
                </div>
              </div>
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="videoCancelBtn" style="padding: 8px 20px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px;">å–æ¶ˆ</button>
                <button id="videoConfirmBtn" style="padding: 8px 20px; border: none; background: #ff6b81; color: white; border-radius: 4px; cursor: pointer; font-size: 14px;">æ’å…¥</button>
              </div>
            </div>
          </div>
        `;

        $('body').append(dialogHtml);

        // å¹³å°åˆ‡æ¢æç¤º
        $('#videoPlatform').on('change', function() {
          const platform = $(this).val();
          const tips = {
            'bilibili': 'æ”¯æŒæ ¼å¼ï¼šhttps://www.bilibili.com/video/BV1xx411c7mD æˆ–ç›´æ¥è¾“å…¥ BV1xx411c7mD',
            'youtube': 'æ”¯æŒæ ¼å¼ï¼šhttps://www.youtube.com/watch?v=dQw4w9WgXcQ æˆ–ç›´æ¥è¾“å…¥ dQw4w9WgXcQ',
            'tencent': 'æ”¯æŒæ ¼å¼ï¼šhttps://v.qq.com/x/page/a0123456789.html æˆ–ç›´æ¥è¾“å…¥ a0123456789'
          };
          $('#platformTip').text(tips[platform]);
        });

        // ç¡®è®¤æŒ‰é’®
        $('#videoConfirmBtn').on('click', function() {
          const platform = $('#videoPlatform').val();
          const url = $('#videoUrl').val().trim();

          if (!url) {
            toastr.warning('è¯·è¾“å…¥è§†é¢‘é“¾æ¥æˆ–ID');
            return;
          }

          let videoId = url;
          let videoHtml = '';

          // è§£æä¸åŒå¹³å°çš„è§†é¢‘IDå¹¶ç”ŸæˆHTML
          if (platform === 'bilibili') {
            const bvMatch = url.match(/BV[a-zA-Z0-9]+/);
            if (bvMatch) {
              videoId = bvMatch[0];
            }
            // ç›´æ¥æ’å…¥Bç«™iframe HTMLä»£ç ï¼Œè¿™æ ·ç¼–è¾‘å™¨ä¹Ÿèƒ½é¢„è§ˆ
            videoHtml = `\n<iframe src="//player.bilibili.com/player.html?bvid=${videoId}&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="width: 100%; height: 500px;"></iframe>\n\n`;
          } else if (platform === 'youtube') {
            const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
            if (ytMatch) {
              videoId = ytMatch[1];
            }
            videoHtml = `\n<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="width: 100%; height: 500px;"></iframe>\n\n`;
          } else if (platform === 'tencent') {
            const tencentMatch = url.match(/\/([a-z0-9]+)\.html/);
            if (tencentMatch) {
              videoId = tencentMatch[1];
            }
            videoHtml = `\n<iframe src="https://v.qq.com/txp/iframe/player.html?vid=${videoId}" frameborder="0" allowfullscreen style="width: 100%; height: 500px;"></iframe>\n\n`;
          }

          // æ’å…¥åˆ°ç¼–è¾‘å™¨
          cm.replaceSelection(videoHtml);

          // å…³é—­å¼¹çª—
          $('.video-dialog-overlay').remove();

          toastr.success('è§†é¢‘æ’å…¥æˆåŠŸï¼å¯åœ¨é¢„è§ˆé¢æ¿æŸ¥çœ‹');
        });

        // å–æ¶ˆæŒ‰é’®
        $('#videoCancelBtn').on('click', function() {
          $('.video-dialog-overlay').remove();
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        $('.video-dialog-overlay').on('click', function(e) {
          if (e.target === this) {
            $(this).remove();
          }
        });

        // ESCé”®å…³é—­
        $(document).on('keydown.videoDialog', function(e) {
          if (e.key === 'Escape') {
            $('.video-dialog-overlay').remove();
            $(document).off('keydown.videoDialog');
          }
        });
      }
    },
    lang: {
      toolbar: {
        mdFile: "å¯¼å…¥MD",
        video: "æ’å…¥è§†é¢‘"
      }
    },


    imageUpload: true,
    imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
    imageUploadURL: "/image/upload",
    onload: function () {
      console.log('onload', this);
      //this.fullscreen();
      //this.unwatch();
      //this.watch().fullscreen();

      //this.setMarkdown("#PHP");
      //this.width("100%");
      //this.height(480);
      //this.resize("100%", 640);

      // ğŸ”¥ åˆå§‹åŒ–å›¾ç‰‡æ‹–æ‹½ç¼©æ”¾åŠŸèƒ½
      if (window.EditorImageResize) {
        EditorImageResize.init(this);
        console.log('[Editor] å›¾ç‰‡ç¼©æ”¾åŠŸèƒ½å·²å¯ç”¨');
      }
    },
    onchange: function () {
      let newVal = this.getMarkdown();
      let add;
      if (newVal.startsWith(lastVal)) {
        add = newVal.substring(lastVal.length);
      } else if (lastVal.startsWith(newVal)) {
        lastVal = newVal;
        return;
      } else {
        add = newVal;
      }

      // è·å–å˜åŒ–çš„å†…å®¹ï¼Œåˆ¤æ–­æ–°å¢å†…å®¹ä¸­æ˜¯å¦å­˜åœ¨å›¾ç‰‡
      const pattern = /!\[(.*?)\]\((.*?)\)/mg;
      let matcher;
      let imgs = [];
      try {
        while ((matcher = pattern.exec(add)) !== null) {
          let target = matcher[0];
          let title = matcher[1];
          let url = matcher[2];
          if (url.length > 0 && url.startsWith("http") && url.indexOf("saveError") < 0) {
            imgs.push({
              'target': target,
              'title': title,
              'url': url,
            })
          }
        }

        // å‰ç«¯è¿™é‡Œå¯ä»¥åšä¸€ä¸ªä¸Šä¼ è¯·æ±‚çš„å¹‚ç­‰ï¼Œé¿å…ç›¸åŒçš„urlé‡å¤ä¸Šä¼ 
        if (imgs.length > 0) {
          console.log("æ‰“å¼€é®ç½©å±‚ï¼Œimgs: ", imgs);
          showMask();
          NProgress.start();

          // ä¸Šä¼ å›¾ç‰‡
          for(let i = 0; i < imgs.length; i++) {
            let upload = imgs[i];
            let lastUploadTime = uploadUrls[upload.url];
            let now = new Date().getTime();
            if (lastUploadTime && now - lastUploadTime < 30_000) {
              console.log("30så†…é˜²é‡å¤æäº¤ï¼Œå¿½ç•¥:", upload.url)
              continue;
            }
            uploadUrls[upload.url] = now;

            console.log("start to upload: ", upload.url, now);
            get("/image/save?img=" + upload.url, "", function (result) {
              let newImg = `![${upload.title}](${result.imagePath})`;
              if (upload.target !== newImg) {
                // è·å–å…‰æ ‡ä½ç½®ï¼Œæ›¿æ¢ä¹‹åé‡æ–°è®¾ç½®
                let cursor = simplemde.getCursor();
                simplemde.setValue(simplemde.getMarkdown().replaceAll(upload.target, newImg));
                simplemde.setCursor({line: cursor.line, ch: cursor.ch})
              }
            });
          }
        }

        lastVal = newVal;
      } catch (e) {
        console.log(e);
      } finally {
        // å…³é—­é®ç½©
        console.log('onchangeï¼Œå…³é—­é®ç½©å±‚');
        hideMask();
        NProgress.done();
      }
    }
  });
  let lastVal = "";
  let uploadUrls = {}

  // å¤åˆ¶ç²˜è´´å›¾ç‰‡
  document.addEventListener('paste', function (event) {
    let items = (event.clipboardData || window.clipboardData).items;
    let file = null;
    if (items && items.length) {
      // æœç´¢å‰ªåˆ‡æ¿items
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          file = items[i].getAsFile();
          break;
        }
      }
    } else {
      toastr.error("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ");
      return;
    }
    if (!file) {
      return;
    }

    // æ­¤æ—¶éœ€è¦å…ˆä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯ï¼Œç„¶å
    let objUrl = getObjectURL(file); //è·å–å›¾ç‰‡çš„è·¯å¾„ï¼Œè¯¥è·¯å¾„ä¸æ˜¯å›¾ç‰‡åœ¨æœ¬åœ°çš„è·¯å¾„
    console.log("æ–‡ç« ç¼–è¾‘å™¨ä¸­ä¸Šä¼ å›¾ç‰‡ï¼š" + { objUrl });

    if (objUrl) {

      if (!checkFileSize(file)) {
        return;
      }

      let formData = new FormData()
      formData.append("image", file)

      // åœ¨è¯·æ±‚å¼€å§‹å‰å¯åŠ¨ NProgress
      NProgress.start();
      // å¼€å¯é®ç½©å±‚
      showMask();

      $.ajax({
        url: "/image/upload",
        type: "post",
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        success: function (data) {
          if (data.status.code === 0) {
            // æ’å…¥ä¸€ä¸ªç©ºè¡Œ
            simplemde.insertValue("\n");
            simplemde.replaceSelection("![](" + data.result.imagePath + ")");
            simplemde.insertValue("\n");
          } else {
            toastr.error(data.status.msg);
          }
        },
        error: function(jqXHR, textStatus, errorThrown) {
          toastr.error("ä¸Šä¼ å¤±è´¥: " + textStatus);
        },
        complete: function() {
          // æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œè¯·æ±‚å®Œæˆååœæ­¢ NProgress
          NProgress.done();
          // å…³é—­é®ç½©
          hideMask();
        }
      })
    }
  });

  function calculateEditorHeight() {
    // æ ¹æ®éœ€è¦è®¡ç®—ç¼–è¾‘å™¨çš„é«˜åº¦ï¼Œä¾‹å¦‚åŸºäºè§†å£é«˜åº¦
    var windowHeight = $(window).height();
    return windowHeight - 55; // å‡å»éœ€è¦çš„è¾¹è·
  }

  $(window).resize(function() {
    var newHeight = calculateEditorHeight();
    simplemde.height(newHeight);
  });

  tagSelect.select2({
    placeholder: 'è¯·é€‰æ‹©ä½ éœ€è¦çš„æ ‡ç­¾ï¼Œæœ€å¤šä¸‰ä¸ª', // æç¤º
    width: '70%', // å®½åº¦
    allowClear: true, // å¯æ¸…ç©º
    debug: true, // ä¸Šçº¿åå…³é—­
    language: 'zh-CN', // ä¸­æ–‡
    maximumSelectionLength: 3, //æœ€å¤šé€‰ä¸‰ä¸ª
    multiple: true, // å¯å¤šé€‰
    // åŠ¨æ€è¯·æ±‚æ•°æ®
    ajax: {
      url: '/article/api/tag/list',
      data: function (params) {
        var query = {
          pageNumber: params.page,
          pageSize: 10,
          key: params.term,
        }

        // æŸ¥è¯¢å‚æ•°å°†æ˜¯ ?search=[term]&type=public
        return query;
      },
      dataType: 'json',
      processResults: function (response, params) {
        console.log("response: ", response)
        console.log("page: ", params.page)
        var data = $.map(response.result.list, function (obj) {
          obj.id = obj.id || obj.tagId;
          obj.text = obj.text || obj.tag;// ç”¨æ‚¨çš„æ ‡è¯†ç¬¦æ›¿æ¢pk

          return obj;
        });
        return {
          results: data,
          pagination: {
            more: response.result.pageNum < response.result.pageTotal// æ€»é¡µæ•°ä¸º10ï¼Œé‚£ä¹ˆ1-9é¡µçš„æ—¶å€™éƒ½å¯ä»¥ä¸‹æ‹‰åˆ·æ–°
          }
        };
      }
    }
  });

  // æå–ç®€ä»‹
  $(".btn-getdistill").on("click", function () {
    // è·å–æ–‡ç« å†…å®¹
    let content = checkContent().trim();
    // å‡†å¤‡æäº¤åˆ°åç«¯
    if (content.length > 600) {
      content = content.substring(0, 600)
    }

    const params = {
      content: content,
    };

    post("/article/api/generateSummary", params, function (data) {
      console.log("æå–åçš„ç®€ä»‹:", data)
      const $summary = $("#summary");
      $summary.val(data);
      // æ»šåŠ¨åˆ°åº•éƒ¨
      $summary.scrollTop($summary.prop('scrollHeight'));
      $('.form-textarea-limit').text(data.length + '/' + summaryMax)
    });

  });

  // æ£€æŸ¥æ ‡é¢˜çš„é•¿åº¦
  function checkTitle() {
    const title = titleInput.val();
    if (title.length <= titleMin) {
      toastr.error("æ–‡ç« æ ‡é¢˜å¤ªçŸ­!")
      return false;
    }
    if (title.length > titleMax) {
      toastr.error("æ–‡ç« æ ‡é¢˜å¤ªé•¿äº†!");
      return false;
    }
    return title;
  }

  // æ£€æŸ¥å†…å®¹çš„é•¿åº¦
  function checkContent() {
    const content = simplemde.getMarkdown();

    if (content.length <= contentMin) {
      toastr.error("æ–‡ç« å†…å®¹å¤ªçŸ­äº†ï¼");
      return false;
    }

    return content;
  }

  //  å‘è¡¨æ–‡ç« 
  $("#publish").on("click", function () {
    doPostArticle("post")
  })
  // ä¿å­˜è‰ç¨¿
  $("#tmpSave").on("click", function () {
    doPostArticle("save")
  })

  // è·å–è¡¨å•ç±»å®¹
  function doPostArticle(action) {
    const title = checkTitle();
    if (!title) {
      return;
    }

    const content = checkContent();
    if (!content) {
      return;
    }

    // åˆ†ç±»é€‰æ‹©
    const category = getChooseCategoryId()
    if (parseInt(category) <= 0) {
      toastr.error("è¯·é€‰æ‹©æ–‡ç« åˆ†ç±»");
      return;
    }
    // å¤„ç†æ ‡ç­¾
    const tagsAll = [];
    $.each(tagSelect.select2('data'), function (index, value) {
      tagsAll.push(value.id);
    });

    if (tagsAll.length <= 0 || tagsAll.length > 3) {
      toastr.error("è¯·é€‰æ‹©1-3ä¸ªæ ‡ç­¾!");
      return;
    }

    const summary = $("#summary").val()
    if (summary.length < contentMin || summary.length > summaryMax) {
      toastr.error("ç®€ä»‹å­—æ•°åº”è¯¥åœ¨6-128ä¹‹é—´å“¦!");
      return;
    }

    // ä»˜è´¹é˜…è¯»åœºæ™¯, ä¿å­˜ä»˜è´¹æ–¹å¼
    let payWay = $('input:radio[name="payWay"]:checked').val();
    let payAmount = $('#payAmountVal').val(); // ä»˜è´¹é‡‘é¢

    const readType = getChooseReadType();
    if (readType == 4) {
      if (payWay == 'email') {
        if (!userPayCode) {
          // ä»˜è´¹é˜…è¯»
          toastr.error("è¯·å†ä¸ªäººé¡µé…ç½®æ”¶æ¬¾ç ä¹‹åï¼Œå†è®¾ç½®æ–‡ç« ä¸ºä»˜è´¹é˜…è¯»å§!")
          return;
        }
      } else {
        if (!payAmount || payAmount <= 0) {
          toastr.error("ä»˜è´¹é‡‘é¢ä¸èƒ½å°äº0!")
          return;
        }
      }
    } else {
      payWay = null;
      payAmount = null;
    }

    let options = {
      title: title,
      content: content,
      categoryId: category,
      readType: readType,
      tagIds: tagsAll,
      summary: summary,
      actionType: action, // post è¡¨ç¤ºå‘è¡¨, saveè¡¨ç¤ºæš‚å­˜
    }
    if (readType == 4) {
      // ä»˜è´¹é˜…è¯»æ–¹å¼
      options['payWay'] = payWay
      if (payAmount) {
        // å…ƒè½¬åˆ†
        options['payAmount'] = parseInt(parseFloat(payAmount) * 100)
      }
    }

    let params = $.extend( {}, defaults, options );
    console.log(params);

    post("/article/api/post", params, function (data) {
      console.log("è¿”å›ç»“æœ:", data)
      // dataç°åœ¨æ˜¯ä¸€ä¸ªå¯¹è±¡,åŒ…å«articleIdå’ŒurlSlug
      if (data.urlSlug && data.urlSlug.length > 0) {
        // ä½¿ç”¨æ–°çš„SEOå‹å¥½URL
        window.location.href = "/article/detail/" + data.articleId + "/" + data.urlSlug
      } else {
        // å…¼å®¹æ²¡æœ‰slugçš„æƒ…å†µ(ç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿ)
        window.location.href = "/article/detail/" + data.articleId
      }
    })
  }

  function getChooseReadType() {
    // é€‰ä¸­æ–‡ç« çš„é˜…è¯»ç±»å‹
    const readType = $("input[name='readType']:radio:checked")
    if (readType.length > 0) {
      return readType.val()
    }
    return 0
  }

  function getChooseCategoryId() {
    const category = $("input[name='category']:radio:checked")
    if (category.length > 0) {
      return category.val()
    }
    return -1
  }

  // æ£€æŸ¥è¾“å…¥ç®€ä»‹æ‘˜è¦çš„é•¿åº¦
  function initSummary() {
    let len = $('#summary').val().length
    if (len > summaryMax) {
      len = summaryMax;
    }
    $('.form-textarea-limit').text(len + '/' + summaryMax)
  }

  // æ§åˆ¶æ–‡ç« åˆ†ç±»çš„é€‰æ‹©
  categoryLabel.each(function (index) {
    (function (index) {
      categoryLabel.eq(index).on('click', function () {
        categoryLabel.removeClass('form-selectgroup-item--active')
                .eq(index).addClass('form-selectgroup-item--active')
      })
    })(index)
  })
  readTypeLabel.each(function (index) {
    (function (index) {
      readTypeLabel.eq(index).on('click', function () {
        readTypeLabel.removeClass('form-selectgroup-item--active')
                .eq(index).addClass('form-selectgroup-item--active')
      })
    })(index)
  })


  // å¤„ç†æŒ‰é’®éšè—æ—¶ä¸å¯ç¼–è¾‘
  editBtn.click(() => {
    if (!showSaveBtnFlagByTitle) return false
    $("#saveModel").modal();
  })

  // å¤„ç†titleè¾“å…¥ä¿å­˜ä»¥åŠæŒ‰é’®æ˜¾éšçš„é—®é¢˜
  const showSaveBtnByTitle = () => {
    const value = titleInput.val()
    const len = value.length
    console.log(value)

    // ä¿å­˜åˆ°æœ¬åœ°
    localStorage.setItem('articleTitle', value)

    if (len > titleMin) {
      editBtn.addClass('edit-save--active')
      showSaveBtnFlagByTitle = true
    } else {
      editBtn.removeClass('edit-save--active')
      showSaveBtnFlagByTitle = false
    }
  }

  // ä»æœ¬åœ°åˆå§‹åŒ–æ ‡é¢˜
  initTitleFormLocalStorage();

  function initTitleFormLocalStorage() {
    const editTitle = titleInput.val();
    // ç¼–è¾‘çš„æ—¶å€™ä¸ä»æœ¬åœ°å–
    if (editTitle) {

    } else {
      const titleValue = localStorage.getItem('articleTitle')
      if (titleValue) {
        titleInput.val(titleValue)
      }
    }

    showSaveBtnByTitle();
  }

  function showByMouseover() {
    let objUrl = pic.attr("src");
    // å·²ç»ä¸Šä¼ è¿‡äº†
    if (objUrl) {
      close_icon.css('display', 'block');
      $('.upload-icon-up').css('visibility', 'hidden');
    } else {
      clickCover.css("visibility", "visible")
    }
  }

  // æ˜¯å¦æ˜¾ç¤ºå°é¢
  function initCover() {
    // æ–‡ç«  IDï¼Œæ–°å»ºæ–‡ç« 
    if (articleId != 0) {
      // ç¼–è¾‘çš„æ—¶å€™ï¼Œæ˜¾ç¤ºå›¾ç‰‡ï¼Œå¦‚æœä¸ºç©ºçš„æ—¶å€™ä¸æ˜¾ç¤º
      if (cover.length > 0) {
        pic.attr("src", cover);
        showByMouseover();
      }
    }
  }

  // åˆå§‹åŒ–å°é¢
  initCover();

  // å°é¢ä¸Šä¼ ç›¸å…³
  $(".custom-file").on("mouseover", ".person-img-inter-wrap", function () {
    console.log("å‡ºç°ä¸Šä¼ çš„æŒ‰é’®")
    showByMouseover();
  }).on("mouseleave", ".person-img-inter-wrap", function () {
    clickCover.css("visibility", "hidden")
  })

  clickCover.click(function () {
    upload.click() //éšè—äº†input:fileæ ·å¼åï¼Œç‚¹å‡»å¤´åƒå°±å¯ä»¥æœ¬åœ°ä¸Šä¼ 
  })

  upload.on("change", function (e) {
    let objUrl = getObjectURL(this.files[0]) //è·å–å›¾ç‰‡çš„è·¯å¾„ï¼Œè¯¥è·¯å¾„ä¸æ˜¯å›¾ç‰‡åœ¨æœ¬åœ°çš„è·¯å¾„

    if (objUrl) {
      console.log("uploadImg", this.value)
      uploadImg(() => (this.value = null), objUrl)
    }
  })

  // åˆ é™¤å›¾ç‰‡å
  close_icon.click(function () {
    pic.attr("src", "").css('visibility', 'hidden');
    close_icon.css('display', 'none');
    $('.upload-icon-up').css('visibility', 'visible');

    // åˆ é™¤å›¾ç‰‡åç½®ç©º
    defaults['cover'] = "";
  })

  // ä¸Šä¼ å¤´å›¾åˆ°æœåŠ¡å™¨
  function uploadImg(callback, objUrl) {
    let uploadPic = upload[0].files[0]
    console.log("å‡†å¤‡ä¸Šä¼ ", uploadPic)

    if (!checkFileSize(uploadPic)) {
      return;
    }

    let file = new FormData()
    file.append("image", uploadPic)
    $.ajax({
      url: "/image/upload",
      type: "post",
      data: file,
      cache: false,
      contentType: false,
      processData: false,
      success: function (data) {
        console.log("response data", data);
        if (data.status.code > 0) {
          // å›¾ç‰‡ä¸Šä¼ å¤±è´¥
          toastr.error(data.status.msg, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥!");
          return;
        }

        const {result: { imagePath },} = data || {}
        defaults['cover'] = imagePath;

        //å°†å›¾ç‰‡è·¯å¾„å­˜å…¥srcä¸­ï¼Œæ˜¾ç¤ºå‡ºå›¾ç‰‡
        pic.attr("src", objUrl).css('visibility', 'visible') // å±•ç¤ºå›¾ç‰‡
        $('.upload-icon-up').css('visibility', 'hidden') // éšè—ä¸Šä¼ 

        callback();
        toastr.info("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ!");
      },
      error : function(jqXHR, textStatus, errorThrown) {
        toastr.error(jqXHR.responseText, "å›¾ç‰‡ä¸Šä¼ å¤±è´¥!");
      },
    })
  }

  // ====================================== æ”¯ä»˜ç›¸å…³
  if (articleId == 0) {
    autoShowOrHidePayDiv(1)
    autoShowPayWayTips('wx_native')
  } else {
    let article = [[${ vo.article }]]
    // å¯¹äºç¼–è¾‘æ–‡ç« æ—¶ï¼Œæ”¯ä»˜æ–¹å¼è¦ä¹ˆæ˜¯ä¸ªäººæ”¶æ¬¾çš„emailï¼Œè¦ä¹ˆå°±æ˜¯å¾®ä¿¡nativeæ”¶æ¬¾
    let initPayWay = article.payWay
    if (initPayWay != 'email') initPayWay = 'wx_native'
    $(`input:radio[value="${initPayWay}"]`).prop('checked', true);
    autoShowOrHidePayDiv(article.readType)
    autoShowPayWayTips(article.payWay)
  }
  // æ ¹æ®inputçš„nameå±æ€§é€‰æ‹©å•é€‰æŒ‰é’®ï¼Œå¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
  $('input:radio[name="readType"]').click(function() {
    var checkValue = $('input:radio[name="readType"]:checked').val();
    console.log('å½“å‰é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼æ˜¯: ', checkValue);
    // å½“é€‰ä¸­ ä»˜è´¹é˜…è¯»æ—¶ï¼Œéœ€è¦å±•ç¤º æ”¯ä»˜æ–¹å¼ + æ”¯ä»˜é‡‘é¢
    autoShowOrHidePayDiv(checkValue)
  });
  function autoShowOrHidePayDiv(readType) {
    if (readType == 4) {
      $('#payReader').attr("style", "display:block")
    } else {
      // ä¸æ˜¾ç¤ºæ”¯ä»˜ç›¸å…³ä¿¡æ¯
      $('#payReader').attr("style", "display:none")
    }
  }

  $('input:radio[name="payWay"]').click(function() {
    var checkValue = $('input:radio[name="payWay"]:checked').val();
    console.log('å½“å‰é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼æ˜¯: ', checkValue);
    // å½“é€‰ä¸­çš„æ”¯ä»˜æ–¹å¼æ˜¯ç»Ÿä¸€å¾®ä¿¡æ”¯ä»˜æ—¶ï¼Œéœ€è¦æ˜¾ç¤ºä»˜è´¹é‡‘é¢ï¼›ä¸ªäººæ”¶æ¬¾ç ä¸ç”¨æ˜¾ç¤ºä»˜è´¹é‡‘é¢
    autoShowPayWayTips(checkValue)
  });
  function autoShowPayWayTips(payWay) {
    if (![[${ global.siteInfo.wxPayEnable }]]) {
      // æ²¡æœ‰å¼€å¯å¾®ä¿¡æ”¯ä»˜åœºæ™¯æ—¶
      payWay = 'email';
      // ä¸å…è®¸é€‰ä¸­å¾®ä¿¡æ”¯ä»˜
      $("input:radio[name='payWay'][value='email']").attr('checked', true);
      $("input:radio[name='payWay'][value='wx_native']").attr("disabled", true).prop("disabled", true);
      $('#wxPayWayLabel').text('ç»Ÿä¸€å¾®ä¿¡æ”¯ä»˜(æœªå¼€å¯)')
    }

    if (payWay == 'email') {
      // ä¸ªäººæ”¶æ¬¾ç æ”¯ä»˜æ–¹å¼ï¼Œä¸å±•ç¤ºä»˜è´¹é‡‘é¢
      $('#payAmount').attr("style", "display:none")
      // æç¤ºä¿¡æ¯å¦‚ä¸‹:
      $('#emailPayTip').attr('style', 'display:block')
      $('#wxPayTip').attr('style', 'display:none')
    } else {
      // å¾®ä¿¡æ”¯ä»˜
      $('#payAmount').attr("style", "display:block")
      // æç¤ºä¿¡æ¯å¦‚ä¸‹:
      $('#emailPayTip').attr('style', 'display:none')
      $('#wxPayTip').attr('style', 'display:block')
    }
  }
</script>
</body>
</html>
