<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="navbar">
  <nav
          th:data-islogin="${global.isLogin}"
          class="navbar navbar-expand-md bg-color-white fixed-top"
  >
    <div class="nav-body">
      <div class="nav-logo-wrap-lg">
        <a class="navbar-logo-wrap" href="/">
          <img class="logo" src="/img/logo.svg" th:src="${global.siteInfo.oss + '/img/logo.svg'}"/>
          <img src="/img/icon.png" class="logo-lg" alt="" th:src="${global.siteInfo.oss + '/img/icon.png'}"/>
        </a>
        <div class="dropdown nav-menu-lg">
          <div class="dropdown">
            <div
                    class="nav-menu-lg-btn dropdown-toggle"
                    type="button"
                    data-toggle="dropdown"
                    aria-expanded="false"
            >
              å¯¼èˆª
              <svg class="nav-menu-arrow" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="dropdown-menu">
              <a class="dropdown-item" href="/">é¦–é¡µ</a>
              <a class="dropdown-item" href="/column">æ•™ç¨‹</a>
              <a class="dropdown-item" href="/chat">æ´¾èªæ˜</a>
            </div>
          </div>
        </div>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav">
          <li
                  th:class="${'nav-item' + (!#strings.equals(global.currentDomain, 'column')
                    && !#strings.equals(global.currentDomain, 'follow')
                    && !#strings.equals(global.currentDomain, 'chat')? ' selected-domain' : '')}"
                  class="nav-item"
          >
            <a class="nav-link" href="/">é¦–é¡µ</a>
          </li>
          <li
                  th:class="${'nav-item' + (#strings.equals(global.currentDomain, 'column') ? ' selected-domain' : '')}"
                  class="nav-item"
          >
            <a class="nav-link" href="/column">æ•™ç¨‹</a>
          </li>
          <li
                  th:class="${'nav-item' + (#strings.equals(global.currentDomain, 'chat') ? ' selected-domain' : '')}"
                  class="nav-item"
          >
            <a class="nav-link" href="/chat">æ´¾èªæ˜</a>
          </li>
        </ul>
      </div>
      <div class="nav-right">
        <button
                type="button"
                class="btn btn-primary nav-article"
                th:data-target="${global.isLogin ? '' : '#loginModal'}"
                th:data-toggle="${global.isLogin ? '' : 'modal'}"
        >
          å†™æ–‡ç« 
        </button>
        <ul th:if="${!global.isLogin}">
          <!--  å¾…ç™»å½• -->
          <li class="nav-item">
            <a
                    class="nav-link"
                    href="#"
                    data-toggle="modal"
                    data-target="#loginModal"
            >
              ç™»å½•
            </a>
          </li>
        </ul>
        <ul th:if="${global.isLogin}" class="nav-right-user">
          <!--  å·²ç™»å½• -->
          <li class="nav-item nav-notice">
            <a class="nav-link navbar-count-msg-box" href="/notice/">
                <span
                        th:if="${global.msgNum != null && global.msgNum > 0}"
                        th:text="${global.msgNum}"
                        class="navbar-count-msg"
                ></span>
              <!-- æ¶ˆæ¯æé†’çš„è§’æ ‡ -->
              <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="icon"
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                      stroke="currentColor"
                      fill="none"
                      stroke-linecap="round"
                      stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                <path
                        d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"
                ></path>
                <path d="M9 17v1a3 3 0 0 0 6 0v-1"></path>
              </svg>
            </a>
          </li>
          <li class="nav-item vip" th:if="${global.user != null && global.user.starStatus != null}">
            <div th:switch="${global.user.starStatus.code}">
              <span th:case="2" th:text="æ˜ŸçƒVIPä¼šå‘˜"></span>
              <span th:case="1" th:text="å¾…å®¡æ ¸"></span>
              <span th:case="4" th:text="å·²è¿‡æœŸ" onclick="vipExpired()"></span>
<!--              <a href="#" data-target="#registerModal" data-toggle="modal" th:case="-1">-->
              <a href="/zsxq/bind" th:case="-1">
                <span th:text="ç»‘å®šæ˜Ÿçƒç¼–å·"></span>
              </a>
            </div>
            <img src="/img/vip.gif" alt="VIP" th:src="${global.siteInfo.oss + '/img/vip.gif'}"/>
          </li>

          <!-- å¤´åƒæ¡† -->
          <div class="nav-right-user">
            <div class="nav-user-avatar">
              <img
                      class="nav-login-img"
                      style="border-radius: 50%"
                      th:src="${global.user.photo}"
                      src="https://static.developers.pub/static/img/logo.b2ff606.jpeg"
                      alt=""
                      loading="lazy"
              />
              <div class="nav-user-arrow"></div>
              <div class="nav-user-dropdown">
                <div class="nav-user-dropdown-inner nav-user-dropdown::before">
                  <!-- ä¸‹è½æ¡†å†…å®¹ -->
                  <!--  è°ƒæ•´ä¸ºæ‰€æœ‰ç”¨æˆ·éƒ½å¯ä»¥ç›´æ¥çœ‹åˆ°ç®¡ç†åå°  th:if="${#strings.equalsIgnoreCase(global.user.role, 'admin')}"-->
                  <!-- æœ¬åœ°ç¯å¢ƒçš„æ—¶å€™ä¸æ˜¾ç¤ºï¼Œæœ¬åœ°ç¯å¢ƒçš„æ—¶å€™é€šè¿‡åç«¯ç›´æ¥å¯åŠ¨ç®¡ç†åå° -->
                  <a
                          th:if="${#strings.equals(global.env, 'prod')}"
                          href="/admin/#/statistics/index"
                          target="_blank"
                          class="dropdown-item"
                  >
                    ç®¡ç†åå°
                  </a>
                  <div
                          th:if="${#strings.equalsIgnoreCase(global.user.role, 'admin')}"
                          class="dropdown-divider"
                  ></div>
                  <a
                          th:href="${'/user/home?userId=' + (global.user?.userId ?: '')}"
                          class="dropdown-item"
                          href="#"
                  >
                    ä¸ªäººä¸»é¡µ
                  </a>
                  <a class="dropdown-item" data-toggle="modal" data-target="#accountModify" href="">è¿ç§»è´¦å·</a>
                  <a id="logoutBtn" href="/logout" class="dropdown-item">ç™»å‡º</a>
                </div>
              </div>
            </div>
          </div>
        </ul>
      </div>
    </div>
  </nav>


  <!-- ç™»å½• Modal -->
  <div
          th:if="${!global.isLogin}"
          class="modal fade"
          id="loginModal"
          data-backdrop="static"
          data-keyboard="false"
          tabindex="-1"
          role="dialog"
          aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">ç™»å½•æŠ€æœ¯æ´¾ç•…äº«æ›´å¤šæƒç›Š</h6>
          <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Close"
          >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="auth-body">
            <div class="login-main">
              <!-- åˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æ˜¯å…¶ä»–ç™»å½•æ¯”å¦‚è¯´ GitHubã€éªŒè¯ç  -->
              <div class="panel">
                <h1 class="title">ç”¨æˆ·åå¯†ç ç™»å½•</h1>
                <!-- ç™»å½•è¡¨å•ã€ç”¨æˆ·åå’Œå¯†ç  -->
                <form id="login-form">
                  <div class="form-group">
                    <input type="text" required autocomplete="off" class="form-control form-control-sm" id="username" placeholder="è¾“å…¥ç”¨æˆ·å">
                  </div>
                  <div class="form-group">
                    <input type="password" required class="form-control form-control-sm" id="password" placeholder="è¾“å…¥å¯†ç ">
                  </div>
                  <button type="submit" class="btn btn-primary btn-block btn-sm">ç™»å½•</button>
                </form>
              </div>
              <div class="other-login-box">
                <div class="oauth-box">
                  <span>å…¶ä»–ç™»å½•ï¼š</span>
                  <div class="oauth">
                    <a class="oauth-bg" href="/login/zsxq" style="background-color: white">
                      <!-- çŸ¥è¯†æ˜Ÿçƒ -->
                      <img class="XNo5Ab" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAB50lEQVR4AWIgFojtnMkH6LVOICKI4jiOjyTJupMkIblZhCRksZIkSQgJuUPIndxHWDchKyErWeQKSRKSlSQhJItFMkKSlbGm77Axft60M7tz8FnM9fu/Y988rKCICmw4TTbOkLXiOCR4DAeow22hEmdwHwpw4Ib0EGern/4J+mlev2x6wDUmDe+axDqyYcPH8W4I/cYeptET8l0H8o7tMC23DeFF9EfsxRxc0cDYf2P+aGj1YpvDuAnXYCnogYIhfEpui7UHtOudEJXKEcccMN942Gl46H8BFzL49oXXMWildRC2Ymp9mgUUpYB8wnkL+EAVWe9ExRfuoDfhAp59eReWLDyvKfT4iy/PtuTvd5twvvb4j+X9yOc01QJ0CKopFFDVIbiVpbIvwfAMGr68O+/kPlyf2QQLmNM1xzu5LCePEiygJFlrf5/hL9ntDCcQPiIT3kH/38U9qew4gQJOJKPsvziMunZPjOFrcMWE3rRj2HjmYwjPS9d7SqYbe3BjKGK1w5Zr+JvuL3UoanBFGSMRJ1w5YDufa/XwKF4DHi5hHpmARWYeJTgBzy+GbcEgrvQloob7Ju01ZSMXdfy6sCVrRDtOMdTJLB7ALt4jhDZwjlycC0k3ZlDAJWr4hIMPPOIYG1Em7C9NIk7FVs7AGgAAAABJRU5ErkJggg==" style="height:18px;width:18px" alt="" data-csiid="ZOSjaNv3F5KuhbIPoezhmAo_3" data-atf="4">
                    </a>
                  </div>
                </div>
                <a class="clickable" data-toggle="modal" data-target="#registerModal" data-dismiss="modal">
                  ç»‘å®šæ˜Ÿçƒï¼Œç•…äº«VIPæœåŠ¡
                </a>
              </div>
            </div>
            <div class="tabpane-container">
              <h2 class="title">å¾®ä¿¡æ‰«ç /é•¿æŒ‰è¯†åˆ«ç™»å½•</h2>
              <div class="first">
                <img class="signin-qrcode" th:src="${global.siteInfo.contactMeWxQrCode}" id="loginQrImg"/>
              </div>

              <div class="explain">
                <!-- æ ¹æ®ç™»å½•ç±»å‹æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯ -->
                <div th:if="${global.loginQrType == 'SUBSCRIPTION_ACCOUNT'}">
                  <bold id="codeTip">è¾“å…¥éªŒè¯ç </bold>
                  <span id="code"></span>
                </div>
                <div th:if="${global.loginQrType == 'SERVICE_ACCOUNT'}">
                  <bold id="codeTip">æ‰«ç å…³æ³¨ç™»å½•</bold>
                </div>
                <!-- çŠ¶æ€å’Œåˆ·æ–°æŒ‰é’®å…±ç”¨ -->
                <div><span id="state">æœ‰æ•ˆæœŸäº”åˆ†é’Ÿ ğŸ‘‰</span> <a id="refreshCode">æ‰‹åŠ¨åˆ·æ–°</a></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="agreement-box">
            <div class="mdnice-user-dialog-footer">
              <p>ç™»å½•å³åŒæ„
                <a href="article/detail/141"
                   target="_blank" rel="noopener noreferrer">
                  ç”¨æˆ·åè®®
                </a> å’Œ
                <a href="article/detail/142"
                   target="_blank" rel="noopener noreferrer">
                  éšç§æ”¿ç­–
                </a>
              </p>
            </div>
          </div>
          <div class="mock-login" th:if="${!#strings.equals(global.env, 'prod')}">
            <!-- éç”Ÿäº§ç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿç™»é™†  -->
            <button
                    id="mockLogin2"
                    type="button"
                    th:data-verify-code="''"
                    class="btn btn-sm btn-light"
            >
              éšæœºæ–°ç”¨æˆ·
            </button>

            <button
                    id="mockLogin"
                    type="button"
                    th:data-verify-code="''"
                    class="btn btn-sm btn-dark"
            >
              ä¸€é”®ç™»å½•
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- ç»‘å®šæ˜Ÿçƒç”¨æˆ· -->
  <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h6 class="modal-title">ç»‘å®šçŸ¥è¯†æ˜Ÿçƒï¼Œç•…äº« VIP å°Šäº«æœåŠ¡ï¼</h6>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="auth-body">
            <div class="register-main">
              <!-- åˆ†ä¸ºä¸Šä¸‹ä¸¤éƒ¨åˆ†ï¼Œä¸‹é¢æ˜¯å…¶ä»–ç™»å½•æ¯”å¦‚è¯´ GitHubã€éªŒè¯ç  -->
              <div class="panel">
                <h1 class="title">
                  <a target="_blank"
                     class="underline"
                     href="https://paicoding.com/article/detail/358">æˆ³æˆ‘äº†è§£å¦‚ä½•è·å–æ˜Ÿçƒç¼–å·ï¼Œæ–°çª—å£æ‰“å¼€</a>
                </h1>
                <form id="register-form">
                  <div class="form-group row">
                    <label  class="col-sm-3 col-form-label col-form-label-sm pr-0" for="starNumber">æ˜Ÿçƒç¼–å·</label>
                    <div class="col-sm-9">
                      <input type="text"
                           placeholder="æˆ³ä¸Šé¢çš„é“¾æ¥ï¼Œä¸€èˆ¬5ä½"
                           class="form-control"
                           required
                           id="starNumber"
                           autocomplete="off">
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-3 col-form-label col-form-label-sm pr-0" for="registerUser">ç”¨æˆ·å</label>
                    <div class="col-sm-9">
                      <input type="text"
                             placeholder="ç”¨æˆ·åå¯†ç æ–¹å¼ç™»å½•æ—¶ç”¨"
                             class="form-control"
                             id="registerUser" required>
                    </div>
                  </div>
                  <div class="form-group row">
                    <label class="col-sm-3 col-form-label col-form-label-sm pr-0" for="registerPassword">å¯†ç </label>
                    <div class="col-sm-9">
                      <input type="password" placeholder="ä½ è‡ªå·±èƒ½è®°å¾—ä½çš„" class="form-control" id="registerPassword" required>
                    </div>
                  </div>
                  <!-- ç»‘å®šè¿‡ä¼šç›´æ¥ç™»å½• -->
                  <button type="submit"
                          class="btn btn-primary btn-block btn-sm"
                          th:text="${global.isLogin} ? 'ç»‘å®š' : 'ç»‘å®šåç™»å½•'">ç»‘å®š/ç»‘å®šåç™»å½•</button>
                </form>
              </div>
            </div>
            <div class="tabpane-container">
              <h2 class="title">æ·»åŠ äºŒå“¥å¾®ä¿¡ qing_gee åŠ é€Ÿå®¡æ ¸</h2>
              <div class="first">
                <img class="signin-qrcode" th:src="${global.siteInfo.contactMeStarQrCode}"/>
              </div>

              <div class="explain">
                <bold>è®°å¾—å¤‡æ³¨</bold>
                <code>æ˜Ÿçƒç¼–å·</code>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--  è´¦å·è¿ç§»å¼¹çª—    -->
  <div th:replace="views/user/info/transfer" th:if="${global.isLogin}"></div>

  <script src="/js/sockjs.min.js" th:src="${global.siteInfo.oss + '/js/sockjs.min.js'}"></script>
  <script src="/js/stomp.min.js" th:src="${global.siteInfo.oss + '/js/stomp.min.js'}"></script>
  <script
          src="/js/mock.js"
          th:if="${!#strings.equals(global.env, 'prod')}"
  ></script>

  <script th:inline="javascript">
    // æ˜¯å¦è‡ªåŠ¨åˆ·æ–°éªŒè¯ç 
    let autoRefresh;
    const stateTag = $('#state'), codeTag = $('#code');

    // ç™»å½•
    $("#login-form").on("submit", function(event) {
      event.preventDefault();

      // è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œæ²¡æœ‰å®šä¹‰ ID
      const username = $("#username").val();
      const password = $("#password").val();

      $.ajax({
        url: "/login/username",
        type: "POST",
        data: {
          username: username,
          password: password
        },
        success: function(response) {
          console.log(response);
          if(response.status.code === 0) {
            // ç™»å½•æˆåŠŸ
            refreshPage();
          } else {
            // ç™»å½•å¤±è´¥
            toastr.error(response.status.msg);
          }
        },
        error: function(error) {
          console.error(error);
          // å‡ºç°é”™è¯¯æ—¶å¦‚ä½•å¤„ç†
        }
      });
    });

    // ç»‘å®šæ˜Ÿçƒ
    $("#register-form").on("submit", function(event) {
      console.log("ç»‘å®šæ˜Ÿçƒ");
      event.preventDefault();

      // è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œæ²¡æœ‰å®šä¹‰ ID
      const registerUser = $('#registerUser').val();
      const starNumber = $("#starNumber").val();
      const password = $("#registerPassword").val();

      $.ajax({
        url: "/login/register",
        type: "POST",
        data: {
          username: registerUser,
          starNumber: starNumber, // ç§»é™¤padStartæ ¼å¼åŒ–ï¼Œç”±åç«¯å¤„ç†
          password: password,
          invitationCode: ''
        },
        success: function(response) {
          console.log(response);
          if(response.status.code === 0) {
            // ç»‘å®šæˆåŠŸï¼Œæ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶è·³è½¬åˆ°ä¸ªäººè¯¦æƒ…é¡µé¢
            toastr.success("ç»‘å®šæˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°ä¸ªäººè¯¦æƒ…é¡µé¢...");
            setTimeout(function() {
              window.location.href = "/user/home?userId=" + response.result;
            }, 1500);
          } else {
            // ç»‘å®šå¤±è´¥
            toastr.error(response.status.msg);
          }
        },
        error: function(error) {
          console.error(error);
          // å‡ºç°é”™è¯¯æ—¶å¦‚ä½•å¤„ç†
        }
      });
    });


    $(".nav-article").click(() => {
      if ([[${global.isLogin}]]) {
        // æ–°é¡µé¢æ‰“å¼€æ–‡ç« ç¼–è¾‘
        // ç§»é™¤æœ¬åœ°ç¼“å­˜
        localStorage.removeItem('articleTitle');
        window.open("/article/edit")
      }
    })

    // å®šä¹‰ä¸€ä¸ªåˆ·æ–°é¡µé¢çš„æ–¹æ³•
    function refreshPage() {
      if (window.location.pathname === "/login") {
        // ç™»å½•æˆåŠŸï¼Œè·³è½¬é¦–é¡µ
        window.location.href = "/";
      } else {
        // åˆ·æ–°å½“å‰é¡µé¢
        window.location.reload();
      }
    }

    /**
     * è®°å½•é•¿è¿æ¥
     * @type {null}
     */
    let sseSource = null;
    let intHook = null;
    let deviceId = null;

    /**
     * å»ºç«‹åŠé•¿è¿æ¥ï¼Œç”¨äºå®ç°è‡ªåŠ¨ç™»å½•
     */
    function buildConnect() {
      if (sseSource != null) {
        try {
          sseSource.close();
        } catch (e) {
          console.log("å…³é—­ä¸Šæ¬¡çš„è¿æ¥", e);
        }
        try {
          window.clearInterval(intHook);
        } catch (e) {
        }
      }

      if(!deviceId) {
        deviceId = getCookie("f-device");
      }
      const subscribeUrl = "/subscribe?deviceId=" + deviceId;
      const source = new EventSource(subscribeUrl);
      sseSource = source;

      source.onmessage = function (event) {
        let text = event.data.replaceAll("\"", "").trim();
        console.log("receive: " + text);

        let newCode;
        if (text.startsWith('refresh#')) {
          // åˆ·æ–°éªŒè¯ç 
          newCode = text.substring(8).trim();
          codeTag.text(newCode);
          stateTag.text("å·²åˆ·æ–° ");
        } else if (text === 'refreshQr!') {
          // æœåŠ¡å·ç™»å½•åˆ·æ–°äºŒç»´ç 
          stateTag.text("å·²åˆ·æ–° ");
        } else if (text === 'scan') {
          // äºŒç»´ç æ‰«æ
          stateTag.text("å·²æ‰«æ ");
        } else if (text.startsWith('login#')) {
          // ç™»å½•æ ¼å¼ä¸º login#cookie
          console.log("ç™»å½•æˆåŠŸ,ä¿å­˜cookie", text)
          document.cookie = text.substring(6);
          source.close();
          refreshPage();
        } else if (text.startsWith("init#")) {
          newCode = text.substring(5).trim();
          codeTag.text(newCode);
          console.log("åˆå§‹åŒ–éªŒè¯ç : ", newCode);
        } else if (text.startsWith("qr#")) {
          let qrImg = text.substring(3);
          $("#loginQrImg").attr('src', qrImg);
        }

        if (newCode != null) {
          try {
            window.clearInterval(intHook);
          } catch (e) {}
        }

        if ([[${!#strings.equals(global.env, 'prod')}]]) {
          $("#mockLogin").attr('data-verify-code', newCode);
          $("#mockLogin2").attr('data-verify-code', newCode);
        }
      };

      source.onopen = function (evt) {
        deviceId = getCookie("f-device");
        console.log("å¼€å§‹è®¢é˜…, è®¾å¤‡id=", deviceId, evt);
      }
      source.onerror = function (e, evt) {
        console.log("è¿æ¥é”™è¯¯ï¼Œé‡æ–°å¼€å§‹", e, evt)
        stateTag.text("è¿æ¥ä¸­æ–­,è¯·åˆ·æ–°é‡è¿");
        buildConnect(code);
      }

      fetchCodeCnt = 0;
      intHook = self.setInterval("fetchCode()", 1000);
    }

    let fetchCodeCnt = 0;
    function fetchCode() {
      if (deviceId) {
        if (++fetchCodeCnt > 5) {
          // ä¸ºäº†é¿å…ä¸åœçš„å‘åç«¯å‘èµ·è¯·æ±‚ï¼Œåšä¸€ä¸ªæœ€å¤§çš„é‡è¯•è®¡æ•°é™åˆ¶
          try {
            window.clearInterval(intHook);
          } catch (e) {}
          return;
        }

        $.ajax({
          url: "/login/fetch?deviceId=" + deviceId, type: "get", dataType: "text", success: function (data) {
            console.log("data>>>>>>>>: ", data);
            if (data != 'fail') {
              codeTag.text(data);
              try {
                window.clearInterval(intHook);
              } catch (e) {}
            }
          },
          error: function (e) {
            console.log("some error! ", e);
          }
        });
      } else {
        console.log("deviceIdæœªè·å–ï¼Œç¨åå†è¯•!");
      }
    }

    function refreshCode() {
      $.ajax({
        url: "/login/refresh?deviceId=" + deviceId, dataType: "json", type: "get", success: function (data) {
          const code = data['result']['code'];
          const reconnect = data['result']['reconnect']
          console.log("éªŒè¯ç åˆ·æ–°å®Œæˆ: ", data);

          if (reconnect) {
            // é‡æ–°å»ºç«‹è¿æ¥
            buildConnect();
            $('#state').text("å·²åˆ·æ–°!");
          } else if(code) {
            if (codeTag.text() !== code) {
              console.log("ä¸»åŠ¨åˆ·æ–°éªŒè¯ç !");
              codeTag.text(code);
              stateTag.text("å·²åˆ·æ–°!");
            } else {
              console.log("éªŒè¯ç å·²åˆ·æ–°äº†!");
            }
          }
        }
      })
    }
    $('#loginModal').on('show.bs.modal', function () {
      console.log("ç™»å½•å¼¹çª—å·²å±•ç¤º!");
      buildConnect();

      // ç§»åŠ¨ç«¯ä¿®æ”¹modal title
      if (window.innerWidth <= 768) {
        $('#loginModal .modal-title').text('å¾®ä¿¡æ‰«ç /é•¿æŒ‰è¯†åˆ«ç™»å½•');

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€æ£€æŸ¥
        initMobileLoginCheck();
      } else {
        $('#loginModal .modal-title').text('ç™»å½•æŠ€æœ¯æ´¾ç•…äº«æ›´å¤šæƒç›Š');
      }

    })
    $('#refreshCode').click(() => {
      refreshCode();
    })

    // è·å–ç”¨æˆ·å¤´åƒå’Œä¸‹è½æ¡†å…ƒç´ 
    const navUserAvatar = document.querySelector('.nav-user-avatar');
    const navUserDropdown = document.querySelector('.nav-user-dropdown');

    if (navUserAvatar != null && navUserDropdown != null) {
      // å½“é¼ æ ‡ç‚¹å‡»ç”¨æˆ·å¤´åƒæ—¶æ˜¾ç¤ºä¸‹è½æ¡†
      navUserAvatar.addEventListener('click', () => {
        // å¦‚æœä¸‹è½æ¡†æ˜¯éšè—çš„ï¼Œåˆ™æ˜¾ç¤ºï¼›å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œåˆ™ä¸å¤„ç†
        if (navUserDropdown.style.display === 'none' || navUserDropdown.style.display === '') {
          navUserDropdown.style.display = 'block';
        }
      });
      // ç‚¹å‡»å…¶ä»–åŒºåŸŸæ—¶éšè—ä¸‹è½æ¡†
      document.addEventListener('click', (event) => {
        // å¦‚æœç‚¹å‡»çš„åŒºåŸŸä¸æ˜¯ç”¨æˆ·å¤´åƒå’Œä¸‹è½æ¡†ï¼Œåˆ™éšè—ä¸‹è½æ¡†
        if (!navUserAvatar.contains(event.target) && !navUserDropdown.contains(event.target)) {
          navUserDropdown.style.display = 'none';
        }
      });
    }

    // --------------- ä¸‹é¢è¿›å…¥å…¨å±€æ¶ˆæ¯é€šçŸ¥çš„å…¥å£ --------------
    function now() {
      return new Date().getTime()
    }

    // ç”¨äºå…¨å±€æ¶ˆæ¯é€šçŸ¥çš„é•¿è¿æ¥
    let userWsSocket = null;
    let userWsClient = null;
    let userWsAckTime = 0;

    function autoBuildNotifyWsConnect() {
      const logined = [[${global.isLogin}]]
      if (!logined) {
        // æœªç™»å½•
        return;
      }

      const session = getCookie("f-session");
      if (session) {
        console.log("ç™»å½•æˆåŠŸï¼Œå‡†å¤‡å»ºç«‹è¿æ¥!!!");

        let protocol = window.location.protocol.replace("http", "ws");
        let host = window.location.host;

        userWsSocket = new WebSocket(`${protocol}//${host}/notify`);
        userWsClient = Stomp.over(userWsSocket);

        userWsClient.connect({"uname": $("#uname").val()}, function (frame) {
          console.log('Connected: ' + frame);
          userWsAckTime = now();
          userWsClient.subscribe(`/user/msg`, function (message) {
            // è®¢é˜…ç”¨æˆ·çš„ç§äººbrokerï¼Œç”¨äºæ¥æ”¶ç³»ç»Ÿç§å‘æ¶ˆæ¯ï¼› åå°é€šè¿‡å‘ /user/xxx/topic/notify å‘é€æ¶ˆæ¯ï¼Œæ¥ä¼ é€’ç»™æŸä¸ªç§äººç”¨æˆ·
            console.log("ç³»ç»Ÿæ¶ˆæ¯: ", message);
            userWsAckTime = now();

            if (message.body != 'pong') {
              let html = `<div>${message.body}</div><div><a href="/notice/" target="_blank" style="color:blue"> æŸ¥çœ‹è¯¦æƒ… </a></div>`
              toastr.success(html);
            }
          });

          userWsClient.subscribe(`/msg`, function (message) {
            // è®¢é˜…å…¨å±€çš„æ¶ˆæ¯
            console.log("ç³»ç»Ÿæ¶ˆæ¯: ", message);
            userWsAckTime = now();
            if (message.body != 'pong') {
              toastr.success(message.body);
            }
          });

        }, {id: session});
      }
    }

    function vipExpired() {
      // ä½¿ç”¨ SweetAlert2 æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
      Swal.fire({
        title: 'VIPå¯èƒ½åˆ°æœŸäº†ï¼Ÿ',
        html: 'è¯·åœ¨ä¸ªäººä¸»é¡µç‚¹å‡»çº¢å­—ï¼Œé€šè¿‡çŸ¥è¯†æ˜Ÿçƒæˆæƒä¸€ä¸‹å°±å¥½äº†ã€‚',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ff8721',
        confirmButtonText: 'è·³è½¬åˆ°ä¸ªäººä¸»é¡µ',
        cancelButtonText: 'ç•™åœ¨å½“å‰é¡µé¢',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // ç”¨æˆ·ç‚¹å‡»ç¡®è®¤ï¼Œè·³è½¬åˆ°ä¸ªäººä¸»é¡µ
          window.location.href = "/user/home?userId=" + [[${global.user != null ? global.user.userId : ''}]];
        }
        // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆï¼Œä¸åšä»»ä½•æ“ä½œ
      });
    }


    function notifyWsCheck() {
      // é•¿è¿æ¥çš„æ ¡éªŒ
      let nowTime = now();
      if (nowTime - userWsAckTime > 90_000) {
        console.log('æœªæ¥æ”¶åˆ°è¿”å›æ¶ˆæ¯ï¼Œé‡æ–°å»ºç«‹é•¿è¿æ¥!');
        autoBuildNotifyWsConnect();
      } else {
        userWsClient.send(`/app/msg/health`, {}, "ping");
      }
    }

    if ([[${global.isLogin}]]) {
      // 30sä¸€æ¬¡çš„ping/pongï¼Œç”¨äºé•¿è¿æ¥çš„ä¿æ´»
      notifyWsCheck();
      setInterval(notifyWsCheck, 30_000)
    }

    // --------------- ç§»åŠ¨ç«¯æ‰«ç ç™»å½•çŠ¶æ€æ£€æŸ¥ --------------
    let visibilityChangeListener = null;
    let loginCheckTimer = null;

    /**
     * åˆå§‹åŒ–ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€æ£€æŸ¥
     * ä¸»è¦ç”¨äºä¼ä¸šæœåŠ¡å·è‡ªåŠ¨æ‰«ç ç™»å½•åœºæ™¯
     */
    function initMobileLoginCheck() {
      // ä»…åœ¨ç§»åŠ¨ç«¯å¯ç”¨
      if (!isMobileDevice()) {
        return;
      }

      // æ¸…ç†ä¹‹å‰çš„ç›‘å¬å™¨
      if (visibilityChangeListener) {
        document.removeEventListener('visibilitychange', visibilityChangeListener);
      }

      // è®°å½•ç™»å½•å¼€å§‹æ—¶é—´
      localStorage.setItem('mobileLoginStartTime', Date.now().toString());
      localStorage.setItem('mobileLoginCheckEnabled', 'true');

      // æ·»åŠ é¡µé¢å¯è§æ€§ç›‘å¬
      visibilityChangeListener = handleVisibilityChange;
      document.addEventListener('visibilitychange', visibilityChangeListener);

      console.log("ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€æ£€æŸ¥å·²åˆå§‹åŒ–");
    }

    /**
     * å¤„ç†é¡µé¢å¯è§æ€§å˜åŒ–
     */
    function handleVisibilityChange() {
      if (!document.hidden) {
        // é¡µé¢é‡æ–°å¯è§ï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€
        checkMobileLoginStatus();
      }
    }

    /**
     * æ£€æŸ¥ç§»åŠ¨ç«¯ç™»å½•çŠ¶æ€
     */
    function checkMobileLoginStatus() {
      const startTime = localStorage.getItem('mobileLoginStartTime');
      const checkEnabled = localStorage.getItem('mobileLoginCheckEnabled');

      if (!startTime || !checkEnabled) {
        return;
      }

      // æ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
      if (Date.now() - parseInt(startTime) > 5 * 60 * 1000) {
        console.log("ç™»å½•æ£€æŸ¥è¶…æ—¶ï¼Œæ¸…ç†çŠ¶æ€");
        cleanupMobileLoginCheck();
        return;
      }

      console.log("æ£€æŸ¥ç™»å½•çŠ¶æ€...");

      // æ˜¾ç¤ºæ£€æŸ¥ä¸­çŠ¶æ€
      stateTag.text("æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...");

      // è°ƒç”¨åç«¯æ¥å£æ£€æŸ¥ç™»å½•çŠ¶æ€
      fetch('/login/status')
        .then(response => response.json())
        .then(data => {
          if (data.status.code === 0 && data.result.loggedIn) {
            // ç™»å½•æˆåŠŸï¼Œåˆ·æ–°é¡µé¢
            console.log("æ£€æµ‹åˆ°ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...");
            cleanupMobileLoginCheck();
            refreshPage();
          } else {
            // æœªç™»å½•ï¼Œç»§ç»­ç­‰å¾…
            console.log("å°šæœªç™»å½•ï¼Œç»§ç»­ç­‰å¾…...");
            stateTag.text("æœ‰æ•ˆæœŸäº”åˆ†é’Ÿ ğŸ‘‰");
          }
        })
        .catch(error => {
          console.error("æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:", error);
          stateTag.text("è¿æ¥ä¸­æ–­ï¼Œè¯·åˆ·æ–°é‡è¿");
        });
    }

    /**
     * æ¸…ç†ç§»åŠ¨ç«¯ç™»å½•æ£€æŸ¥
     */
    function cleanupMobileLoginCheck() {
      localStorage.removeItem('mobileLoginStartTime');
      localStorage.removeItem('mobileLoginCheckEnabled');

      if (visibilityChangeListener) {
        document.removeEventListener('visibilitychange', visibilityChangeListener);
        visibilityChangeListener = null;
      }

      if (loginCheckTimer) {
        clearTimeout(loginCheckTimer);
        loginCheckTimer = null;
      }
    }

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
     */
    function isMobileDevice() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
             window.innerWidth <= 768;
    }

    /**
     * è·å–Cookieå€¼
     */
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', function() {
      cleanupMobileLoginCheck();
    });

  </script>
</div>
</html>
