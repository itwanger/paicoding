<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.paicoding.forum.service.user.repository.mapper.UserAiMapper">

    <sql id="limit">
        <if test="pageParam != null">
            limit #{pageParam.offset}, #{pageParam.limit}
        </if>
    </sql>

    <sql id="zsxqWhitesByParams">
        where a.deleted = ${@com.github.paicoding.forum.api.model.enums.YesOrNoEnum@NO.code}
        <if test="searchParams.userCode != null and searchParams.userCode != ''">
            and u.user_name like concat('%', #{searchParams.userCode}, '%')
        </if>
        <if test="searchParams.name != null and searchParams.name != ''">
            and ui.user_name like concat('%', #{searchParams.name}, '%')
        </if>
        <if test="searchParams.starNumber != null and searchParams.starNumber != ''">
            and a.star_number like concat('%', #{searchParams.starNumber}, '%')
        </if>
        <if test="searchParams.status != null and searchParams.status != -1">
            and a.state = #{searchParams.status}
        </if>
        <if test="searchParams.starNumberNotEmpty != null and searchParams.starNumberNotEmpty == true">
            and a.star_number is not null and a.star_number != ''
        </if>
        <if test="searchParams.lastLoginWithinWeek != null and searchParams.lastLoginWithinWeek == true">
            and u.update_time >= date_sub(now(), interval 7 day)
        </if>
    </sql>

    <select id="listZsxqUsersByParams"
            resultType="com.github.paicoding.forum.api.model.vo.user.dto.ZsxqUserInfoDTO">
        select a.id, a.user_id, a.star_number, a.invite_code,
            a.invite_num, a.state, u.user_name as user_code,
            a.strategy, u.login_type, date_format(a.star_expire_time, '%Y-%m-%d') as expireTime,
            ui.user_name as name, ui.photo as avatar, u.update_time as lastLoginTime
        from user_ai a
        left join user u on u.id = a.user_id
        left join user_info ui on a.user_id = ui.user_id
        <include refid="zsxqWhitesByParams"/>
        order by 
        <choose>
            <when test="searchParams.starNumberNotEmpty != null and searchParams.starNumberNotEmpty == true">
                cast(a.star_number as unsigned) asc, a.update_time desc
            </when>
            <otherwise>
                a.update_time desc
            </otherwise>
        </choose>
        <include refid="limit"/>
    </select>
    <select id="countZsxqUsersByParams" resultType="java.lang.Long">
        select count(*) from user_ai a
        left join user u on u.id = a.user_id
        left join user_info ui on a.user_id = ui.user_id
        <include refid="zsxqWhitesByParams"/>
    </select>

</mapper>
